import{a0 as je,P as qe,a2 as Le,o as h,x as d,z as L,A as We,aw as He,a7 as P,a8 as n,a6 as b,c as l,af as v,ac as z,ag as be,ab as w,ae as N,K as p,ad as i,ax as E,an as V,ao as ke,aj as Ze,ai as ae,am as te,ap as Ge,U as Ke,a9 as le,av as ne,aa as oe,as as se,ak as Re,au as Je,H as Ve,at as Qe,ay as Xe,az as Ye}from"./index-EoLtR7Ym.js";import{l as ea}from"./lodash-DHyxJ22h.js";import{C as Ie}from"./ConfirmDeleteDialogWithTextField-CMsJX0fm.js";import{V as aa}from"./VContainer-DkdgYygS.js";import{a as I,V as de}from"./VRow-dqbYjOyI.js";import{V as Ce,a as ta}from"./VDataTableServer-B-LcFFzZ.js";import{V as ie}from"./VForm-pYgC_4YV.js";import{V as la}from"./VCombobox-8nLyr3gO.js";import{V as na}from"./VTooltip-C1zG8ekc.js";import{T as xe}from"./index-EqHmgjHM.js";import{b as oa,V as _e}from"./VList-CyvEtY9o.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VCheckboxBtn-DGPE0p8X.js";import"./VDivider-DIT931LT.js";const sa={key:0},da={class:"d-flex justify-center h-25"},ia={class:"mb-8"},ra={class:"text-pink-lighten-2"},ua={class:"card-title ps-6 py-3"},ma={__name:"department",setup(pa){const{smAndUp:T,mdAndUp:K}=qe(),{apiAuth:C}=Qe(),c=Le(),U=h(()=>T.value?"default":"small"),F=d([]),De=h(()=>X.value.map(t=>({...t,displayName:`${t.name} (${t.companyId})`}))),re=h(()=>{if(!W.value||!o.value.departmentId)return"(選擇公司、部門代碼後顯示)";let t=o.value.departmentId;return typeof t=="object"&&(t=t.value),t=t.replace(/^[A-Z]\d+/,""),`${W.value.companyId}${t}`}),R=[{title:"IT",value:"IT",name:"IT部"},{title:"OP",value:"OP",name:"OP部"},{title:"TO (線控)",value:"TO",name:"線控部"},{title:"AT (機控)",value:"AT",name:"機控部"},{title:"BC (直售)",value:"BC",name:"直售部"},{title:"BB (同業)",value:"BB",name:"同業部"},{title:"BD (商務)",value:"BD",name:"商務部"},{title:"CI (企業獎勵)",value:"CI",name:"企獎部"},{title:"MD (行銷美編)",value:"MD",name:"行銷美編部"},{title:"FM (財務管理)",value:"FM",name:"財務管理部"},{title:"GB (高爾夫球)",value:"GB",name:"高爾夫球事業部"}],Pe=()=>{if(typeof o.value.departmentId=="object"){const t=R.find(e=>e.value===o.value.departmentId.value);t&&(o.value.name=t.name)}ue()},W=h(()=>x.value.find(t=>t._id===o.value.c_id)),ue=()=>{if(W.value&&o.value.departmentId){let t=o.value.departmentId;typeof t=="object"&&(t=t.value),o.value.departmentId=t.replace(/^[A-Z]\d+/,"")}},me=d(0),J=d(!1),B=d(10),S=d([{key:"departmentId",order:"asc"}]),m=d(1),$=d(0),H=d(""),M=d(""),we={class:"header-bg"},pe=[{title:"部編",key:"departmentId",align:"start",minWidth:"68px",sortable:!0},{title:"公司",key:"c_id.name",align:"start",minWidth:"68px",sortable:!0},{title:"部門",key:"name",align:"start",minWidth:"68px",sortable:!0},{title:"人數",key:"memberCount",align:"start",sortable:!1},{title:"操作",key:"actions",align:"center",sortable:!1}],he=h(()=>T.value?pe:pe.filter(t=>["departmentId","name","memberCount","actions"].includes(t.key))),x=d([]),Z=d({open:!1}),r=d({open:!1,_id:"",companyId:"",name:""}),_=d({open:!1,_id:"",name:""}),A=d({name:""}),O=d([]),G=d([]),Q=d([]),g=d({open:!1,id:null}),D=d({open:!1,id:"",name:"",companyName:""}),o=d({c_id:"",name:"",departmentId:"",hasChanges:!0}),j=d([]),q=d([]),k=d(!1),ce=async()=>{try{const{data:t}=await C.get("/company/all");t.success&&(x.value=t.result)}catch{c({text:"載入公司列表失敗",snackbarProps:{color:"red-lighten-1"}})}},X=h(()=>[...x.value].sort((t,e)=>{const a=t.companyId||"",s=e.companyId||"";return a.localeCompare(s)})),y=async(t=!1)=>{var e,a;t&&(m.value=1),J.value=!0;try{const s={page:m.value,itemsPerPage:B.value,sortBy:((e=S.value[0])==null?void 0:e.key)||"departmentId",sortOrder:((a=S.value[0])==null?void 0:a.order)||"asc",companyId:M.value||null,search:H.value||null},{data:u}=await C.get("/department/all",{params:s});u.success&&(Q.value=u.result.data,$.value=u.result.pagination.totalItems,console.log("Total items:",$.value))}catch{c({text:"載入部門列表失敗",snackbarProps:{color:"red-lighten-1"}}),Q.value=[],$.value=0}finally{J.value=!1}},ve=async()=>{Z.value.open=!0,await ce()},ze=()=>{Z.value.open=!1,A.value={name:""},O.value=[]},Te=t=>{r.value={open:!0,_id:t._id,companyId:t.companyId,name:t.name}},fe=()=>{r.value={open:!1,id:"",companyId:"",name:""},G.value=[]},Ue=async()=>{var t,e;if(!A.value.name){O.value=["請輸入公司名稱"];return}k.value=!0;try{const{data:a}=await C.post("/company",{name:A.value.name});a.success&&(x.value.push(a.result),A.value={name:""},O.value=[],c({text:"新增公司成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){O.value=[((e=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:e.message)||"新增失敗"]}finally{k.value=!1}},Be=async()=>{var t,e;if(!r.value.name){G.value=["請輸入公司名稱"];return}k.value=!0;try{const{data:a}=await C.patch(`/company/${r.value._id}`,{name:r.value.name,companyId:r.value.companyId});if(a.success){const s=x.value.findIndex(u=>u._id===r.value._id);s!==-1&&(x.value[s]=a.result),r.value={open:!0,_id:"",companyId:"",name:""},G.value=[],fe(),c({text:"修改公司成功",snackbarProps:{color:"teal-lighten-1"}})}}catch(a){c({text:((e=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:e.message)||"修改失敗",snackbarProps:{color:"red-lighten-1"}})}finally{k.value=!1}},Se=t=>{_.value={open:!0,_id:t._id,name:t.name}},$e=async()=>{var t,e;try{await C.delete(`/company/${_.value._id}`),x.value=x.value.filter(a=>a._id!==_.value._id),_.value.open=!1,c({text:"刪除公司成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){c({text:((e=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},ge=()=>{g.value.open=!0,o.value={c_id:"",name:"",departmentId:"",hasChanges:!0,originalData:null}},Y=()=>{g.value={open:!1,id:null},o.value={c_id:"",name:"",departmentId:"",originalData:null,hasChanges:!1},j.value=[],q.value=[],F.value=[]},Ae=t=>{var u;g.value={open:!0,id:t._id};const e=((u=t.c_id)==null?void 0:u._id)||t.c_id,a=t.departmentId.replace(/^[A-Z]\d+/,""),s=R.find(f=>f.value===a);o.value={c_id:e,name:t.name,departmentId:s||a,originalData:{c_id:e,name:t.name,departmentId:t.departmentId},hasChanges:!1}},Ne=async()=>{var s,u;if(j.value=[],q.value=[],F.value=[],!o.value.c_id){q.value=["請選擇公司"];return}if(!o.value.name){j.value=["請輸入部門名稱"];return}if(!o.value.departmentId){F.value=["請輸入部門代碼"];return}let t=o.value.departmentId;if(typeof t=="object"&&(t=t.value),!W.value){q.value=["請先選擇公司"];return}const e=re.value;k.value=!0;const a=m.value;try{if(g.value.id){const{data:f}=await C.patch(`/department/${g.value.id}`,{c_id:o.value.c_id,name:o.value.name,departmentId:e});f.success&&(Y(),c({text:"修改部門成功",snackbarProps:{color:"teal-lighten-1"}}),m.value=a,await y(!1))}else{const{data:f}=await C.post("/department",{c_id:o.value.c_id,name:o.value.name,departmentId:e});f.success&&(await y(!0),Y(),c({text:"新增部門成功",snackbarProps:{color:"teal-lighten-1"}}))}}catch(f){const ee=((u=(s=f==null?void 0:f.response)==null?void 0:s.data)==null?void 0:u.message)||"操作失敗";ee.includes("部門代碼已存在")?F.value=["此部門代碼已存在"]:ee.includes("部門名稱已存在")?j.value=["此部門名稱已存在"]:c({text:ee,snackbarProps:{color:"red-lighten-1"}})}finally{k.value=!1}},Ee=t=>{var e;D.value={open:!0,id:t._id,name:t.name,companyName:((e=t.c_id)==null?void 0:e.name)||"未知公司"}},Fe=async()=>{var t,e;try{const a=m.value;await C.delete(`/department/${D.value.id}`),D.value.open=!1,$.value--;const s=Math.ceil($.value/B.value);a>s?m.value=Math.max(1,s):m.value=a,await y(!1),c({text:"刪除部門成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){c({text:((e=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},Me=h(()=>o.value.originalData?o.value.c_id!==o.value.originalData.c_id||o.value.name!==o.value.originalData.name||o.value.departmentId!==o.value.originalData.departmentId:!0),Oe=async t=>{const{page:e,itemsPerPage:a,sortBy:s}=t;m.value=e,B.value=a,S.value=s,await y(!1),localStorage.setItem("departmentTablePage",e.toString())},ye=ea.debounce(()=>{y(!0)},300);return L(M,()=>{y(!0)}),L(H,()=>{m.value=1,ye()}),L([B,S],()=>{y(!0)}),L(M,()=>{m.value=1,y(!0)}),L(()=>o.value.c_id,()=>{o.value.departmentId&&ue()}),We(async()=>{const t=localStorage.getItem("departmentTablePage");t&&parseInt(t)>0&&(m.value=parseInt(t),me.value++),await ce(),await y(!1)}),He(()=>{localStorage.setItem("departmentTablePage",m.value.toString()),ye.cancel()}),(t,e)=>(b(),P(aa,{"max-width":"1400"},{default:n(()=>[l(de,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:n(()=>[l(I,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:n(()=>[e[16]||(e[16]=v("h3",null,"公司部門管理",-1)),z(T)?be((b(),P(w,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"ms-4"},null,512)),[[xe,"人數為「在職」人數"]]):N("",!0)]),_:1}),l(I,{cols:"12"},{default:n(()=>[l(de,null,{default:n(()=>[l(I,null,{default:n(()=>[l(de,null,{default:n(()=>[z(K)?N("",!0):(b(),P(I,{key:0,cols:"6"},{default:n(()=>[l(p,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",block:"",onClick:ve},{default:n(()=>e[17]||(e[17]=[i(" 公司管理 ")])),_:1})]),_:1})),z(K)?N("",!0):(b(),P(I,{key:1,cols:"6"},{default:n(()=>[l(p,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",block:"",onClick:ge},{default:n(()=>e[18]||(e[18]=[i(" 新增部門 ")])),_:1})]),_:1})),z(K)?(b(),P(I,{key:2},{default:n(()=>[l(p,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",onClick:ve},{default:n(()=>e[19]||(e[19]=[i(" 公司管理 ")])),_:1}),l(p,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",class:"ms-3",onClick:ge},{default:n(()=>e[20]||(e[20]=[i(" 新增部門 ")])),_:1})]),_:1})):N("",!0),l(I,{cols:"6",md:"3",lg:"2"},{default:n(()=>[l(Ce,{modelValue:M.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>M.value=a),e[1]||(e[1]=a=>y(!0))],items:[{name:"全部",_id:""},...X.value],label:"選擇公司","item-title":"name","item-value":"_id",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","items"])]),_:1}),l(I,{cols:"6",md:"3",lg:"2",class:"d-flex justify-end align-center"},{default:n(()=>[z(T)?be((b(),P(w,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[xe,"可搜尋部門編號、部門名稱","top"]]):N("",!0),l(E,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=a=>H.value=a),label:"搜尋","append-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(I,{cols:"12"},{default:n(()=>[(b(),P(ta,{key:me.value,"items-per-page":B.value,"onUpdate:itemsPerPage":e[3]||(e[3]=a=>B.value=a),"sort-by":S.value,"onUpdate:sortBy":e[4]||(e[4]=a=>S.value=a),items:Q.value,"items-length":$.value,loading:J.value,page:m.value,headers:he.value,"header-props":we,density:"compact","items-per-page-options":[10,20,50],hover:"","onUpdate:options":Oe},{item:n(({item:a,index:s})=>{var u;return[v("tr",{class:Ze({"odd-row":s%2===0,"even-row":s%2!==0})},[v("td",null,V(a.departmentId||"尚未設定"),1),z(T)?(b(),ke("td",sa,V(((u=a.c_id)==null?void 0:u.name)||"未設定"),1)):N("",!0),v("td",null,V(a.name),1),v("td",null,V(a.employeeCount)+" 人",1),v("td",da,[l(p,{icon:"",color:"light-blue-darken-4",variant:"plain",size:U.value,ripple:!1,onClick:f=>Ae(a)},{default:n(()=>[l(w,null,{default:n(()=>e[21]||(e[21]=[i("mdi-pencil")])),_:1})]),_:2},1032,["size","onClick"]),l(p,{icon:"",color:"red-lighten-1",variant:"plain",size:U.value,ripple:!1,onClick:f=>Ee(a)},{default:n(()=>[l(w,null,{default:n(()=>e[22]||(e[22]=[i("mdi-delete")])),_:1})]),_:2},1032,["size","onClick"])])],2)]}),_:1},8,["items-per-page","sort-by","items","items-length","loading","page","headers"]))]),_:1})]),_:1})]),_:1})]),_:1}),l(se,{modelValue:Z.value.open,"onUpdate:modelValue":e[6]||(e[6]=a=>Z.value.open=a),persistent:"",width:"395"},{default:n(()=>[l(ae,{class:"rounded-lg pa-4"},{default:n(()=>[e[28]||(e[28]=v("div",{class:"card-title ps-6 py-3"}," 公司管理 ",-1)),l(te,{class:"px-4 pb-2"},{default:n(()=>[v("div",ia,[(b(!0),ke(Ke,null,Ge(X.value,a=>(b(),P(Xe,{key:a._id,class:"ms-2 me-4 mb-2 pa-4 pe-1",color:"blue-grey-darken-2",label:""},{default:n(()=>[v("span",ra,V(a.companyId)+" ",1),i(" "+V(a.name)+" ",1),l(Ye,null,{activator:n(({props:s})=>[l(p,Ve({icon:"",size:"x-small",variant:"text",class:"ms-2",ripple:!1,color:"white",ref_for:!0},s),{default:n(()=>[l(w,{color:"cyan-darken-3"},{default:n(()=>e[23]||(e[23]=[i(" mdi-dots-vertical ")])),_:1})]),_:2},1040)]),default:n(()=>[l(oa,{density:"compact"},{default:n(()=>[l(_e,{density:"compact",class:"ps-2 pe-3 py-0",onClick:s=>Te(a)},{default:n(()=>[l(w,{icon:"mdi-pencil",size:"16",color:"light-blue-darken-4"}),e[24]||(e[24]=v("span",{style:{"font-size":"14px"},class:"ps-2 text-blue-grey-darken-2"},"編輯",-1))]),_:2},1032,["onClick"]),l(_e,{density:"compact",class:"ps-2 pe-3 py-0",color:"red-lighten-1",onClick:s=>Se(a)},{default:n(()=>[l(w,{icon:"mdi-delete",size:"16",color:"red-lighten-1"}),e[25]||(e[25]=v("span",{style:{"font-size":"14px"},class:"ps-2 text-blue-grey-darken-2"},"刪除",-1))]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),l(ie,{onSubmit:le(Ue,["prevent"])},{default:n(()=>[l(E,{modelValue:A.value.name,"onUpdate:modelValue":e[5]||(e[5]=a=>A.value.name=a),"error-messages":O.value,label:"新增公司",required:"",variant:"outlined",density:"compact",class:"px-2"},null,8,["modelValue","error-messages"]),l(ne,{class:"pa-0 mt-2"},{default:n(()=>[l(oe),l(p,{color:"red-lighten-1",variant:"outlined",size:U.value,onClick:ze},{default:n(()=>e[26]||(e[26]=[i(" 取消 ")])),_:1},8,["size"]),l(p,{color:"teal-darken-1",variant:"outlined",type:"submit",size:U.value,loading:k.value,class:"ms-2"},{default:n(()=>e[27]||(e[27]=[i(" 新增 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(se,{modelValue:r.value.open,"onUpdate:modelValue":e[9]||(e[9]=a=>r.value.open=a),persistent:"",width:"400"},{default:n(()=>[l(ae,{class:"rounded-lg pa-4"},{default:n(()=>[l(Re,{class:"text-h6 ps-4 py-3"},{default:n(()=>e[29]||(e[29]=[i(" 編輯公司 ")])),_:1}),l(te,null,{default:n(()=>[l(ie,{onSubmit:le(Be,["prevent"])},{default:n(()=>[l(E,{modelValue:r.value.companyId,"onUpdate:modelValue":e[7]||(e[7]=a=>r.value.companyId=a),label:"公司編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"]),l(E,{modelValue:r.value.name,"onUpdate:modelValue":e[8]||(e[8]=a=>r.value.name=a),"error-messages":G.value,label:"公司名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"]),l(ne,{class:"pa-0 mt-4"},{default:n(()=>[l(oe),l(p,{color:"red-lighten-1",variant:"outlined",onClick:fe},{default:n(()=>e[30]||(e[30]=[i(" 取消 ")])),_:1}),l(p,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:k.value,class:"ms-2"},{default:n(()=>e[31]||(e[31]=[i(" 修改 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(se,{modelValue:g.value.open,"onUpdate:modelValue":e[13]||(e[13]=a=>g.value.open=a),persistent:"",width:"360"},{default:n(()=>[l(ae,{class:"rounded-lg px-4 pt-4 pb-1"},{default:n(()=>[v("div",ua,V(g.value.id?"編輯部門":"新增部門"),1),l(te,null,{default:n(()=>[l(ie,{onSubmit:le(Ne,["prevent"])},{default:n(()=>[l(Ce,{modelValue:o.value.c_id,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.c_id=a),items:De.value,label:"選擇公司","item-title":"displayName","item-value":"_id",required:"",variant:"outlined",density:"compact",class:"mb-4","error-messages":q.value},null,8,["modelValue","items","error-messages"]),l(la,{modelValue:o.value.departmentId,"onUpdate:modelValue":[e[11]||(e[11]=a=>o.value.departmentId=a),Pe],items:R,"item-title":"title","item-value":"value",label:"部門代碼",required:"",variant:"outlined",density:"compact",class:"mb-1","error-messages":F.value,clearable:""},Je({_:2},[z(T)?{name:"append-inner",fn:n(()=>[l(na,{location:"top","close-delay":"200"},{activator:n(({props:a})=>[l(w,Ve(a,{icon:"mdi-information",size:"18"}),null,16)]),default:n(()=>[e[32]||(e[32]=i(" 可選擇預設部門代碼或自行輸入 "))]),_:1})]),key:"0"}:void 0]),1032,["modelValue","error-messages"]),l(E,{class:"mb-2 text-grey-darken-1",variant:"outlined",density:"compact",readonly:"","persistent-placeholder":"",label:"部門編號預覽"},{default:n(()=>[i(V(re.value),1)]),_:1}),l(E,{modelValue:o.value.name,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.name=a),label:"部門名稱",required:"",variant:"outlined",density:"compact","error-messages":j.value},null,8,["modelValue","error-messages"]),l(ne,{class:"pa-0 mt-4"},{default:n(()=>[l(oe),l(p,{color:"red-lighten-1",variant:"outlined",size:U.value,onClick:Y},{default:n(()=>e[33]||(e[33]=[i(" 取消 ")])),_:1},8,["size"]),l(p,{color:"teal-darken-1",variant:"outlined",size:U.value,type:"submit",loading:k.value,disabled:g.value.id?!Me.value:!1,class:"ms-2"},{default:n(()=>[i(V(g.value.id?"修改":"新增"),1)]),_:1},8,["size","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Ie,{modelValue:_.value.open,"onUpdate:modelValue":e[14]||(e[14]=a=>_.value.open=a),title:"確認刪除公司",message:`確定要刪除公司「<span class='text-pink-lighten-1' style='font-weight: 800;'>${_.value.name}</span>」嗎？此操作無法復原。`,"expected-name":_.value.name,"input-label":"公司名稱",onConfirm:$e},null,8,["modelValue","message","expected-name"]),l(Ie,{modelValue:D.value.open,"onUpdate:modelValue":e[15]||(e[15]=a=>D.value.open=a),title:"確認刪除部門",message:`確定要刪除「<span class='text-teal-darken-2' style='font-weight: 800;'>${D.value.companyName}</span>」的「<span class='text-pink-lighten-1' style='font-weight: 800;'>${D.value.name}</span>」嗎？此操作無法復原。`,"expected-name":D.value.name,"input-label":"部門名稱",onConfirm:Fe},null,8,["modelValue","message","expected-name"])]),_:1}))}},wa=je(ma,[["__scopeId","data-v-a693d0fb"]]);export{wa as default};
