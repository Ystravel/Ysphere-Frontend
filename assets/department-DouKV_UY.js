import{_ as ze,P as he,Z as Se,o as Z,x as s,z as G,A as $e,ar as Ee,a2 as k,a3 as t,a1 as p,c as l,aa as g,a7 as P,ab as ue,a6 as U,a9 as I,K as u,a8 as d,as as z,ah as C,ai as re,ap as Te,ad as J,ag as O,aj as Be,U as Fe,a4 as Q,aq as X,a5 as Y,am as ee,ae as Ae,an as qe,at as Ne}from"./index-CjvnmibE.js";import{l as We}from"./lodash-DHyxJ22h.js";import{C as me}from"./ConfirmDeleteDialogWithTextField-hGNvvxtt.js";import{V as je}from"./VContainer-DWVRi4H_.js";import{a as y,V as ae}from"./VRow-ds3MicoJ.js";import{V as pe,a as Le}from"./VDataTableServer-B5WpIS_H.js";import{V as le}from"./VForm-BgrLBsai.js";import{T as ce}from"./index-D02Xd6EV.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-DLLgVg6g.js";import"./VDivider-F13Wpc2o.js";import"./VCheckboxBtn-CwylDLc6.js";import"./VTooltip-Cj7i4HeH.js";const He={key:0},Me={class:"d-flex justify-center h-25"},Ke={class:"mb-8"},Re={class:"card-title ps-6 py-3"},Ze={__name:"department",setup(Ge){const{smAndUp:h,mdAndUp:j}=he(),{apiAuth:b}=qe(),r=Se(),D=Z(()=>h.value?"default":"small"),L=s(!1),T=s(10),B=s([{key:"departmentId",order:"asc"}]),H=s(1),M=s(0),S=s(""),$=s(""),ve={class:"header-bg"},te=[{title:"部編",key:"departmentId",align:"start",minWidth:"68px",sortable:!0},{title:"公司",key:"c_id.name",align:"start",minWidth:"68px",sortable:!0},{title:"部門",key:"name",align:"start",minWidth:"68px",sortable:!0},{title:"人數",key:"memberCount",align:"start",sortable:!0},{title:"操作",key:"actions",align:"center",sortable:!1}],fe=Z(()=>h.value?te:te.filter(n=>["departmentId","name","memberCount","actions"].includes(n.key))),c=s([]),F=s({open:!1}),i=s({open:!1,_id:"",companyId:"",name:""}),V=s({open:!1,_id:"",name:""}),w=s({name:""}),E=s([]),A=s([]),K=s([]),m=s({open:!1,id:null}),x=s({open:!1,id:"",name:""}),o=s({c_id:"",name:"",departmentId:"",hasChanges:!0}),q=s([]),N=s([]),v=s(!1),ne=async()=>{try{const{data:n}=await b.get("/company/all");n.success&&(c.value=n.result)}catch{r({text:"載入公司列表失敗",snackbarProps:{color:"red-lighten-1"}})}},f=async(n=!1)=>{n&&(H.value=1),L.value=!0;try{const e={companyId:$.value||null,search:S.value||null},{data:a}=await b.get("/department/all",{params:e});a.success&&(K.value=a.result,M.value=a.result.length||0)}catch{r({text:"載入部門列表失敗",snackbarProps:{color:"red-lighten-1"}}),K.value=[],M.value=0}finally{L.value=!1}},oe=async()=>{F.value.open=!0,await ne()},ge=()=>{F.value.open=!1,w.value={name:""},E.value=[]},ye=n=>{i.value={open:!0,_id:n._id,companyId:n.companyId,name:n.name}},se=()=>{i.value={open:!1,id:"",companyId:"",name:""},A.value=[]},be=async()=>{var n,e;if(!w.value.name){E.value=["請輸入公司名稱"];return}v.value=!0;try{const{data:a}=await b.post("/company",{name:w.value.name});a.success&&(c.value.push(a.result),w.value={name:""},E.value=[],r({text:"新增公司成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){E.value=[((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"新增失敗"]}finally{v.value=!1}},Ve=async()=>{var n,e;if(!i.value.name){A.value=["請輸入公司名稱"];return}v.value=!0;try{const{data:a}=await b.patch(`/company/${i.value._id}`,{name:i.value.name,companyId:i.value.companyId});if(a.success){const _=c.value.findIndex(W=>W._id===i.value._id);_!==-1&&(c.value[_]=a.result),i.value={open:!0,_id:"",companyId:"",name:""},A.value=[],se(),r({text:"修改公司成功",snackbarProps:{color:"teal-lighten-1"}})}}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"修改失敗",snackbarProps:{color:"red-lighten-1"}})}finally{v.value=!1}},ke=n=>{V.value={open:!0,_id:n._id,name:n.name}},Ce=async()=>{var n,e;try{await b.delete(`/company/${V.value._id}`),c.value=c.value.filter(a=>a._id!==V.value._id),V.value.open=!1,r({text:"刪除公司成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},de=()=>{m.value.open=!0,o.value={c_id:"",name:"",departmentId:"",hasChanges:!0}},R=()=>{m.value={open:!1,id:null},o.value={c_id:"",name:"",departmentId:"",originalData:null,hasChanges:!1},q.value=[],N.value=[]},xe=n=>{var a;console.log("編輯部門資料:",n),m.value={open:!0,id:n._id};const e=((a=n.c_id)==null?void 0:a._id)||n.c_id;o.value={c_id:e,name:n.name,departmentId:n.departmentId,originalData:{c_id:e,name:n.name,departmentId:n.departmentId},hasChanges:!1},console.log("設置後的表單值:",o.value)},_e=async()=>{var n,e;if(q.value=[],N.value=[],!o.value.c_id){N.value=["請選擇公司"];return}if(!o.value.name){q.value=["請輸入部門名稱"];return}v.value=!0;try{if(m.value.id){const{data:a}=await b.patch(`/department/${m.value.id}`,{c_id:o.value.c_id,name:o.value.name,departmentId:o.value.departmentId});a.success&&(await f(),R(),r({text:"修改部門成功",snackbarProps:{color:"teal-lighten-1"}}))}else{const{data:a}=await b.post("/department",{c_id:o.value.c_id,name:o.value.name});a.success&&(await f(),R(),r({text:"新增部門成功",snackbarProps:{color:"teal-lighten-1"}}))}}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"操作失敗",snackbarProps:{color:"red-lighten-1"}})}finally{v.value=!1}},Ie=n=>{x.value={open:!0,id:n._id,name:n.name}},De=async()=>{var n,e;try{await b.delete(`/department/${x.value.id}`),await f(),x.value.open=!1,r({text:"刪除部門成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},we=Z(()=>o.value.originalData?o.value.c_id!==o.value.originalData.c_id||o.value.name!==o.value.originalData.name||o.value.departmentId!==o.value.originalData.departmentId:!0),Pe=n=>{H.value=n.page,T.value=n.itemsPerPage,B.value=n.sortBy,f()},ie=We.debounce(()=>{f(!0)},300);return G($,()=>{f(!0)}),G(S,()=>{ie()}),G([T,B,$],()=>{f(!0)}),$e(async()=>{await ne(),await f()}),Ee(()=>{ie.cancel()}),(n,e)=>(p(),k(je,{"max-width":"1400"},{default:t(()=>[l(ae,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:t(()=>[l(y,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:t(()=>[e[16]||(e[16]=g("h3",null,"公司部門管理",-1)),P(h)?ue((p(),k(U,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"ms-4"},null,512)),[[ce,"人數為「在職」人數"]]):I("",!0)]),_:1}),l(y,{cols:"12"},{default:t(()=>[l(ae,null,{default:t(()=>[l(y,null,{default:t(()=>[l(ae,null,{default:t(()=>[P(j)?I("",!0):(p(),k(y,{key:0,cols:"6"},{default:t(()=>[l(u,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",block:"",onClick:oe},{default:t(()=>e[17]||(e[17]=[d(" 公司管理 ")])),_:1})]),_:1})),P(j)?I("",!0):(p(),k(y,{key:1,cols:"6"},{default:t(()=>[l(u,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",block:"",onClick:de},{default:t(()=>e[18]||(e[18]=[d(" 新增部門 ")])),_:1})]),_:1})),P(j)?(p(),k(y,{key:2},{default:t(()=>[l(u,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",onClick:oe},{default:t(()=>e[19]||(e[19]=[d(" 公司管理 ")])),_:1}),l(u,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",class:"ms-3",onClick:de},{default:t(()=>e[20]||(e[20]=[d(" 新增部門 ")])),_:1})]),_:1})):I("",!0),l(y,{cols:"6",md:"3",lg:"2"},{default:t(()=>[l(pe,{modelValue:$.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>$.value=a),e[1]||(e[1]=a=>f(!0))],items:[{name:"全部",_id:""},...c.value],label:"選擇公司","item-title":"name","item-value":"_id",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","items"])]),_:1}),l(y,{cols:"6",md:"3",lg:"2",class:"d-flex justify-end align-center"},{default:t(()=>[P(h)?ue((p(),k(U,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[ce,"可搜尋部門編號、部門名稱","top"]]):I("",!0),l(z,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=a=>S.value=a),label:"搜尋","append-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(y,{cols:"12"},{default:t(()=>[l(Le,{"items-per-page":T.value,"onUpdate:itemsPerPage":e[3]||(e[3]=a=>T.value=a),"sort-by":B.value,"onUpdate:sortBy":e[4]||(e[4]=a=>B.value=a),headers:fe.value,"header-props":ve,items:K.value,"items-length":M.value,loading:L.value,page:H.value,density:"compact","items-per-page-options":[10,20,50],search:S.value,class:"rounded-ts-lg rounded-te-lg py-3",hover:"","onUpdate:options":Pe},{item:t(({item:a,index:_})=>{var W;return[g("tr",{class:Te({"odd-row":_%2===0,"even-row":_%2!==0})},[g("td",null,C(a.departmentId||"尚未設定"),1),P(h)?(p(),re("td",He,C(((W=a.c_id)==null?void 0:W.name)||"未設定"),1)):I("",!0),g("td",null,C(a.name),1),g("td",null,C(a.employeeCount)+" 人",1),g("td",Me,[l(u,{icon:"",color:"light-blue-darken-4",variant:"plain",size:D.value,onClick:Ue=>xe(a)},{default:t(()=>[l(U,null,{default:t(()=>e[21]||(e[21]=[d("mdi-pencil")])),_:1})]),_:2},1032,["size","onClick"]),l(u,{icon:"",color:"red-lighten-1",variant:"plain",size:D.value,onClick:Ue=>Ie(a)},{default:t(()=>[l(U,null,{default:t(()=>e[22]||(e[22]=[d("mdi-delete")])),_:1})]),_:2},1032,["size","onClick"])])],2)]}),_:1},8,["items-per-page","sort-by","headers","items","items-length","loading","page","search"])]),_:1})]),_:1})]),_:1})]),_:1}),l(ee,{modelValue:F.value.open,"onUpdate:modelValue":e[6]||(e[6]=a=>F.value.open=a),persistent:"",width:"444"},{default:t(()=>[l(J,{class:"rounded-lg pa-4"},{default:t(()=>[e[27]||(e[27]=g("div",{class:"card-title ps-6 py-3"}," 公司管理 ",-1)),l(O,{class:"px-4 pb-2"},{default:t(()=>[g("div",Ke,[(p(!0),re(Fe,null,Be(c.value,a=>(p(),k(Ne,{key:a.id,class:"mx-2 mb-2 pa-4 pe-1",color:"blue-grey-darken-1",label:""},{default:t(()=>[d(C(a.companyId)+" "+C(a.name)+" ",1),l(u,{icon:"",size:"x-small",variant:"text",class:"ms-2",ripple:!1,color:"light-blue-darken-4",onClick:_=>ye(a)},{default:t(()=>[l(U,null,{default:t(()=>e[23]||(e[23]=[d("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),l(u,{icon:"",size:"x-small",variant:"text",ripple:!1,color:"red-lighten-1",onClick:_=>ke(a)},{default:t(()=>[l(U,null,{default:t(()=>e[24]||(e[24]=[d("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024))),128))]),l(le,{onSubmit:Q(be,["prevent"])},{default:t(()=>[l(z,{modelValue:w.value.name,"onUpdate:modelValue":e[5]||(e[5]=a=>w.value.name=a),"error-messages":E.value,label:"公司名稱",required:"",variant:"outlined",density:"compact",class:"px-2"},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-2"},{default:t(()=>[l(Y),l(u,{color:"red-lighten-1",variant:"outlined",size:D.value,onClick:ge},{default:t(()=>e[25]||(e[25]=[d(" 取消 ")])),_:1},8,["size"]),l(u,{color:"teal-darken-1",variant:"outlined",type:"submit",size:D.value,loading:v.value,class:"ms-2"},{default:t(()=>e[26]||(e[26]=[d(" 新增 ")])),_:1},8,["size","loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:i.value.open,"onUpdate:modelValue":e[9]||(e[9]=a=>i.value.open=a),persistent:"",width:"400"},{default:t(()=>[l(J,{class:"rounded-lg pa-4"},{default:t(()=>[l(Ae,{class:"text-h6 ps-4 py-3"},{default:t(()=>e[28]||(e[28]=[d(" 編輯公司 ")])),_:1}),l(O,null,{default:t(()=>[l(le,{onSubmit:Q(Ve,["prevent"])},{default:t(()=>[l(z,{modelValue:i.value.companyId,"onUpdate:modelValue":e[7]||(e[7]=a=>i.value.companyId=a),label:"公司編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"]),l(z,{modelValue:i.value.name,"onUpdate:modelValue":e[8]||(e[8]=a=>i.value.name=a),"error-messages":A.value,label:"公司名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-4"},{default:t(()=>[l(Y),l(u,{color:"red-lighten-1",variant:"outlined",onClick:se},{default:t(()=>e[29]||(e[29]=[d(" 取消 ")])),_:1}),l(u,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:v.value,class:"ms-2"},{default:t(()=>e[30]||(e[30]=[d(" 修改 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:m.value.open,"onUpdate:modelValue":e[13]||(e[13]=a=>m.value.open=a),persistent:"",width:"360"},{default:t(()=>[l(J,{class:"rounded-lg px-4 pt-4 pb-1"},{default:t(()=>[g("div",Re,C(m.value.id?"編輯部門":"新增部門"),1),l(O,null,{default:t(()=>[l(le,{onSubmit:Q(_e,["prevent"])},{default:t(()=>[m.value.id?(p(),k(z,{key:0,modelValue:o.value.departmentId,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.departmentId=a),label:"部門編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"])):I("",!0),l(pe,{modelValue:o.value.c_id,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.c_id=a),items:c.value,label:"選擇公司","item-title":"name","item-value":"_id",required:"",variant:"outlined",density:"compact",class:"mb-4","error-messages":N.value},null,8,["modelValue","items","error-messages"]),l(z,{modelValue:o.value.name,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.name=a),label:"部門名稱",required:"",variant:"outlined",density:"compact","error-messages":q.value},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-4"},{default:t(()=>[l(Y),l(u,{color:"red-lighten-1",variant:"outlined",size:D.value,onClick:R},{default:t(()=>e[31]||(e[31]=[d(" 取消 ")])),_:1},8,["size"]),l(u,{color:"teal-darken-1",variant:"outlined",size:D.value,type:"submit",loading:v.value,disabled:m.value.id?!we.value:!1,class:"ms-2"},{default:t(()=>[d(C(m.value.id?"修改":"新增"),1)]),_:1},8,["size","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(me,{modelValue:V.value.open,"onUpdate:modelValue":e[14]||(e[14]=a=>V.value.open=a),title:"確認刪除公司",message:`確定要刪除公司「${V.value.name}」嗎？此操作無法復原。`,"expected-name":V.value.name,"input-label":"公司名稱",onConfirm:Ce},null,8,["modelValue","message","expected-name"]),l(me,{modelValue:x.value.open,"onUpdate:modelValue":e[15]||(e[15]=a=>x.value.open=a),title:"確認刪除部門",message:`確定要刪除部門「${x.value.name}」嗎？此操作無法復原。`,"expected-name":x.value.name,"input-label":"部門名稱",onConfirm:De},null,8,["modelValue","message","expected-name"])]),_:1}))}},ia=ze(Ze,[["__scopeId","data-v-fa73528e"]]);export{ia as default};
