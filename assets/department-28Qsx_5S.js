import{_ as ge,P as fe,Z as ye,o as J,x as u,z as L,A as be,ar as Ve,a2 as z,a3 as s,an as Ie,a1 as x,c as l,aa as I,a8 as h,a7 as n,ab as ee,a6 as M,a9 as B,K as $,as as K,ah as N,ai as ke,ap as xe,a4 as he,ad as we,ag as Ce,aq as Pe,a5 as De,am as Se}from"./index-D8RXzR7Z.js";import{l as Ue}from"./lodash-DHyxJ22h.js";import{c as _e,a as ae,b as ze,u as Be,d as R}from"./vee-validate-DzFTCTO5.js";import{C as $e}from"./ConfirmDeleteDialogWithTextField-QL8VC9iu.js";import{V as Ne}from"./VContainer-V1IIkLJ-.js";import{a as p,V as q}from"./VRow-BnNS2wlk.js";import{V as le,a as Oe}from"./VDataTableServer-Bay3rTu7.js";import{V as Te}from"./VForm-DAw3XVzK.js";import{T as te}from"./index-D6ewy-tp.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-CtncbhTl.js";import"./VDivider-WUYLBmdo.js";import"./VCheckboxBtn-DU7S808n.js";import"./VTooltip-BWRGC7-1.js";const Fe={key:0},Me={class:"text-center"},qe={class:"ps-4 py-3 card-title"},Ae={__name:"department",setup(Ee){const{smAndUp:k}=fe(),{apiAuth:O}=Ie(),w=ye(),T=J(()=>k.value?"default":"small"),A=[{id:1,name:"永信台北"},{id:2,name:"永信桃園"},{id:3,name:"永信台中"},{id:4,name:"永信高雄"},{id:5,name:"好漾台北"},{id:6,name:"好漾台中"},{id:7,name:"銳皇國際"},{id:8,name:"集睿創映"}],C=u(""),P=u(null),se={class:"header-bg"},y=u(!1),g=u(10),c=u([{key:"departmentId",order:"asc"}]),m=u(1),E=u(0),b=u(""),W=[{title:"編號",key:"departmentId",align:"start",width:"15%",sortable:!0},{title:"公司",key:"companyId",align:"start",width:"25%",sortable:!0},{title:"部門",key:"name",align:"start",width:"30%",sortable:!0},{title:"人數",key:"memberCount",align:"start",sortable:!0},{title:"操作",key:"actions",align:"center",sortable:!1}],ne=J(()=>k.value?W:W.filter(a=>["departmentId","name","memberCount","actions"].includes(a.key))),oe=a=>{console.log("表格更新選項:",a),(a.page!==m.value||a.itemsPerPage!==g.value||JSON.stringify(a.sortBy)!==JSON.stringify(c.value))&&(m.value=a.page,g.value=a.itemsPerPage,c.value=a.sortBy,v(!1))},j=u([]),d=u({open:!1,id:null}),F=u(!1),f=u(null),re=_e({name:ae().required("請輸入部門名稱"),companyId:ze().required("請選擇所屬公司"),departmentId:ae().nullable()}),{handleSubmit:de,isSubmitting:Z,resetForm:G}=Be({validationSchema:re}),D=R("name"),S=R("companyId"),U=R("departmentId",void 0,{validateOnValueUpdate:!1}),Q=Object.fromEntries(A.map(a=>[a.id,a.name])),v=async(a=!1)=>{var e,o,i,V,t,_;a&&(m.value=1),y.value=!0;try{console.log("載入部門列表，參數:",{page:m.value,itemsPerPage:g.value,sortBy:((e=c.value[0])==null?void 0:e.key)||"companyId",sortOrder:((o=c.value[0])==null?void 0:o.order)||"asc",search:b.value,companyId:C.value});const{data:r}=await O.get("/department/all",{params:{page:m.value,itemsPerPage:g.value,sortBy:((i=c.value[0])==null?void 0:i.key)||"companyId",sortOrder:((V=c.value[0])==null?void 0:V.order)||"asc",search:b.value,companyId:C.value}});if(r.success&&r.result){j.value=r.result.data,E.value=r.result.totalItems;const H=Math.ceil(r.result.totalItems/g.value);m.value>H&&H>0&&(m.value=H,a||await v(!1))}else throw new Error(r.message||"載入失敗")}catch(r){console.error("載入部門列表錯誤:",r),w({text:((_=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:_.message)||"載入部門列表失敗",snackbarProps:{color:"red-lighten-1"}}),j.value=[],E.value=0}finally{y.value=!1}},ue=()=>{d.value={open:!0,id:null},G()},ie=a=>{d.value={open:!0,id:a._id},P.value={name:a.name,companyId:a.companyId,departmentId:a.departmentId},D.value.value=a.name,S.value.value=a.companyId,U.value.value=a.departmentId,f.value=a},X=()=>{d.value.open=!1,G(),f.value=null,P.value=null},me=a=>{f.value=a,F.value=!0},pe=J(()=>{if(!d.value.id)return!0;if(!P.value)return!1;const a={name:D.value.value,companyId:S.value.value,departmentId:U.value.value||""};return Object.keys(P.value).some(e=>{const o=P.value[e]??"",i=a[e]??"";return o!==i})}),ce=de(async a=>{var e,o;y.value=!0;try{d.value.id?await O.patch(`/department/${d.value.id}`,{name:a.name,companyId:a.companyId,departmentId:a.departmentId}):await O.post("/department",{name:a.name,companyId:a.companyId}),await v(),X(),w({text:`部門${d.value.id?"修改":"新增"}成功`,snackbarProps:{color:"teal-lighten-1"}})}catch(i){const V=((o=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:o.message)||"操作失敗";w({text:V,snackbarProps:{color:"red-lighten-1"}})}y.value=!1}),ve=async()=>{var a,e;y.value=!0;try{await O.delete(`/department/${f.value._id}`),await v(),w({text:"部門刪除成功",snackbarProps:{color:"teal-lighten-1"}})}catch(o){w({text:((e=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}F.value=!1,f.value=null,y.value=!1},Y=Ue.debounce(()=>{v(!0)},300);return L(b,()=>{m.value=1,Y()}),L([g,c],()=>{v(!0)}),L([b,C],()=>{m.value=1,v(!0)}),be(()=>{v()}),Ve(()=>{Y.cancel()}),(a,e)=>(x(),z(Ne,{"max-width":"1400"},{default:s(()=>{var o,i,V;return[l(q,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:s(()=>[l(p,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:s(()=>[e[10]||(e[10]=I("h3",null," 公司部門管理 ",-1)),e[11]||(e[11]=h()),n(k)?ee((x(),z(M,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"ms-4"},null,512)),[[te,"人數為「在職」人數"]]):B("",!0)]),_:1}),l(p,{cols:"12"},{default:s(()=>[l(q,null,{default:s(()=>[l(p,null,{default:s(()=>[l(q,null,{default:s(()=>[l(p,null,{default:s(()=>[l($,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",onClick:ue},{default:s(()=>e[12]||(e[12]=[h(" 新增部門 ")])),_:1})]),_:1}),n(k)?B("",!0):(x(),z(p,{key:0,cols:"6"})),l(p,{cols:"6",sm:"4",md:"3",lg:"2"},{default:s(()=>[l(le,{modelValue:C.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>C.value=t),e[1]||(e[1]=t=>v(!0))],items:[{name:"全部",id:""},...A],label:"選擇公司","item-title":"name","item-value":"id",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","items"])]),_:1}),l(p,{cols:"6",sm:"4",md:"3",class:"d-flex justify-end align-center ps-0"},{default:s(()=>[n(k)?ee((x(),z(M,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4 ps-2"},null,512)),[[te,"可搜尋部門名稱或編號","top"]]):B("",!0),l(K,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=t=>b.value=t),label:"搜尋","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(p,{cols:"12"},{default:s(()=>[l(Oe,{"items-per-page":g.value,"onUpdate:itemsPerPage":e[3]||(e[3]=t=>g.value=t),"sort-by":c.value,"onUpdate:sortBy":e[4]||(e[4]=t=>c.value=t),page:m.value,headers:ne.value,items:j.value,"header-props":se,"items-length":E.value,"items-per-page-options":[10,20,50],loading:y.value,search:b.value,class:"rounded-ts-lg rounded-te-lg py-3",hover:"",density:"compact","onUpdate:options":oe},{item:s(({item:t,index:_})=>[I("tr",{class:xe({"odd-row":_%2===0,"even-row":_%2!==0})},[I("td",null,N(t.departmentId||"尚未設定"),1),n(k)?(x(),ke("td",Fe,N(n(Q)[t.companyId]||"未知公司"),1)):B("",!0),I("td",null,N(t.name),1),I("td",null,N(t.memberCount||0)+" 人",1),I("td",Me,[l(q,{class:"d-flex justify-center my-1"},{default:s(()=>[l(p,{cols:"6",sm:"4",md:"3",lg:"2",class:"pa-0 mx-1"},{default:s(()=>[l($,{icon:"",color:"light-blue-darken-4",variant:"plain",width:"28",height:"32",size:T.value,ripple:!1,onClick:r=>ie(t)},{default:s(()=>[l(M,null,{default:s(()=>e[13]||(e[13]=[h("mdi-pencil")])),_:1})]),_:2},1032,["size","onClick"])]),_:2},1024),l(p,{cols:"6",sm:"4",md:"3",lg:"2",class:"pa-0 mx-1"},{default:s(()=>[l($,{icon:"",color:"red-lighten-1",variant:"plain",width:"28",height:"32",size:T.value,ripple:!1,onClick:r=>me(t)},{default:s(()=>[l(M,null,{default:s(()=>e[14]||(e[14]=[h("mdi-delete")])),_:1})]),_:2},1032,["size","onClick"])]),_:2},1024)]),_:2},1024)])],2)]),_:1},8,["items-per-page","sort-by","page","headers","items","items-length","loading","search"])]),_:1})]),_:1})]),_:1})]),_:1}),l(Se,{modelValue:d.value.open,"onUpdate:modelValue":e[8]||(e[8]=t=>d.value.open=t),persistent:"",width:"360"},{default:s(()=>[l(Te,{onSubmit:he(n(ce),["prevent"])},{default:s(()=>[l(we,{class:"rounded-lg pa-4 pt-6"},{default:s(()=>[I("div",qe,N(d.value.id?"編輯部門":"新增部門"),1),l(Ce,{class:"px-3"},{default:s(()=>[d.value.id?(x(),z(K,{key:0,modelValue:n(U).value.value,"onUpdate:modelValue":e[5]||(e[5]=t=>n(U).value.value=t),"error-messages":n(U).errorMessage.value,label:"部門編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue","error-messages"])):B("",!0),l(le,{modelValue:n(S).value.value,"onUpdate:modelValue":e[6]||(e[6]=t=>n(S).value.value=t),"error-messages":n(S).errorMessage.value,items:A,"item-title":"name","item-value":"id",label:"選擇公司",required:"",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue","error-messages"]),l(K,{modelValue:n(D).value.value,"onUpdate:modelValue":e[7]||(e[7]=t=>n(D).value.value=t),"error-messages":n(D).errorMessage.value,label:"部門名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"])]),_:1}),l(Pe,null,{default:s(()=>[l(De),l($,{color:"red-lighten-1",variant:"outlined",size:T.value,loading:n(Z),onClick:X},{default:s(()=>e[15]||(e[15]=[h(" 取消 ")])),_:1},8,["size","loading"]),l($,{color:"teal-darken-1",variant:"outlined",type:"submit",size:T.value,class:"ms-1",loading:n(Z),disabled:d.value.id&&!pe.value},{default:s(()=>e[16]||(e[16]=[h(" 送出 ")])),_:1},8,["size","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1},8,["modelValue"]),l($e,{modelValue:F.value,"onUpdate:modelValue":e[9]||(e[9]=t=>F.value=t),title:"確認刪除部門",message:`確定要刪除「${n(Q)[(o=f.value)==null?void 0:o.companyId]}」的「${(i=f.value)==null?void 0:i.name}」嗎？此操作無法復原。`,"expected-name":((V=f.value)==null?void 0:V.name)||"","input-label":"部門名稱",onConfirm:ve},null,8,["modelValue","message","expected-name"])]}),_:1}))}},la=ge(Ae,[["__scopeId","data-v-c033accc"]]);export{la as default};
