import{_ as Pe,P as Ue,Z as he,x as s,o as de,z as ue,A as Se,ar as $e,a2 as N,a3 as t,a1 as w,c as l,aa as k,a7 as re,ab as Ee,a6 as E,a9 as H,K as m,a8 as d,as as _,ah as V,ai as ie,ad as K,ae as O,ag as R,aj as Be,U as Te,a4 as W,aq as Z,a5 as G,am as J,an as Fe,at as qe}from"./index-CpwiecUo.js";import{l as Ae}from"./lodash-DHyxJ22h.js";import{C as me}from"./ConfirmDeleteDialogWithTextField-CBRBD8OI.js";import{V as Ne}from"./VContainer-BrOEZygi.js";import{a as C,V as Q}from"./VRow-BuWWP4oh.js";import{V as pe,a as ze}from"./VDataTableServer-yS5J-id5.js";import{V as X}from"./VForm-BC0fIA7X.js";import{T as Le}from"./index-BMajZ0R8.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-CZSAr9l9.js";import"./VDivider-akpbFvUx.js";import"./VCheckboxBtn-DwlQm0sk.js";import"./VTooltip-C255JNyA.js";const Me={key:0},je={class:"text-center"},He={class:"mb-4"},Ke={__name:"department",setup(Oe){const{smAndUp:z}=Ue(),{apiAuth:g}=Fe(),p=he(),L=s(!1),P=s(10),x=s([{key:"departmentId",order:"asc"}]),B=s(1),Y=s(0),U=s(""),T=s(""),ee=[{title:"編號",key:"departmentId",align:"start",width:"15%",sortable:!0},{title:"公司",key:"companyId",align:"start",width:"25%",sortable:!0},{title:"部門",key:"name",align:"start",width:"30%",sortable:!0},{title:"人數",key:"memberCount",align:"start",sortable:!0},{title:"操作",key:"actions",align:"center",sortable:!1}],ve=de(()=>z.value?ee:ee.filter(n=>["departmentId","name","memberCount","actions"].includes(n.key))),c=s([]),F=s({open:!1}),r=s({open:!1,_id:"",companyId:"",name:""}),y=s({open:!1,_id:"",name:""}),h=s({name:""}),q=s([]),A=s([]),ae=s([]),v=s({open:!1,id:null}),I=s({open:!1,id:"",name:""}),o=s({companyId:"",name:"",departmentId:"",hasChanges:!0}),S=s([]),$=s([]),f=s(!1),le=async()=>{try{const{data:n}=await g.get("/company/all");n.success&&(c.value=n.result)}catch{p({text:"載入公司列表失敗",snackbarProps:{color:"red-lighten-1"}})}},b=async(n=!1)=>{var e,a;n&&(B.value=1),L.value=!0;try{const{data:u}=await g.get("/department/all",{params:{page:B.value,itemsPerPage:P.value,sortBy:((e=x.value[0])==null?void 0:e.key)||"departmentId",sortOrder:((a=x.value[0])==null?void 0:a.order)||"asc",search:U.value,companyId:T.value}});u.success&&(ae.value=u.result.data,Y.value=u.result.totalItems)}catch{p({text:"載入部門列表失敗",snackbarProps:{color:"red-lighten-1"}})}finally{L.value=!1}},ce=async()=>{F.value.open=!0,await le()},te=()=>{F.value.open=!1,h.value={name:""},q.value=[]},fe=n=>{r.value={open:!0,_id:n._id,companyId:n.companyId,name:n.name}},ne=()=>{r.value={open:!1,id:"",companyId:"",name:""},A.value=[]},ge=async()=>{var n,e;if(!h.value.name){q.value=["請輸入公司名稱"];return}f.value=!0;try{const{data:a}=await g.post("/company",{name:h.value.name});a.success&&(c.value.push(a.result),te(),p({text:"新增公司成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){q.value=[((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"新增失敗"]}finally{f.value=!1}},ye=async()=>{var n,e;if(!r.value.name){A.value=["請輸入公司名稱"];return}f.value=!0;try{const{data:a}=await g.patch(`/company/${r.value._id}`,{companyId:r.value.companyId,name:r.value.name});if(a.success){const u=c.value.findIndex(D=>D._id===r.value._id);u!==-1&&(c.value[u]=a.result),ne(),p({text:"修改公司成功",snackbarProps:{color:"teal-lighten-1"}})}}catch(a){A.value=[((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"修改失敗"]}finally{f.value=!1}},be=n=>{y.value={open:!0,_id:n._id,name:n.name}},Ve=async()=>{var n,e;try{await g.delete(`/company/${y.value._id}`),c.value=c.value.filter(a=>a._id!==y.value._id),y.value.open=!1,p({text:"刪除公司成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){p({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},Ie=()=>{v.value.open=!0,o.value={companyId:"",name:"",departmentId:"",hasChanges:!0}},M=()=>{v.value={open:!1,id:null},o.value={companyId:"",name:"",departmentId:"",originalData:null,hasChanges:!1},S.value=[],$.value=[]},ke=n=>{v.value={open:!0,id:n._id},o.value={companyId:n.companyId._id,name:n.name,departmentId:n.departmentId,originalData:{companyId:n.companyId._id,name:n.name,departmentId:n.departmentId},hasChanges:!1}},Ce=async()=>{var n,e,a,u,D,se;if(S.value=[],$.value=[],!o.value.companyId){$.value=["請選擇公司"];return}if(!o.value.name){S.value=["請輸入部門名稱"];return}f.value=!0;try{if(v.value.id){const{data:i}=await g.patch(`/department/${v.value.id}`,{companyId:o.value.companyId,name:o.value.name,departmentId:o.value.departmentId});i.success&&(await b(),M(),p({text:"修改部門成功",snackbarProps:{color:"teal-lighten-1"}}))}else{const{data:i}=await g.post("/department",{companyId:o.value.companyId,name:o.value.name});i.success&&p({text:"新增部門成功",snackbarProps:{color:"teal-lighten-1"}})}await b(),M()}catch(i){const j=((e=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:e.message)||"操作失敗";((u=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:u.field)==="name"?S.value=[j]:((se=(D=i==null?void 0:i.response)==null?void 0:D.data)==null?void 0:se.field)==="companyId"?$.value=[j]:p({text:j,snackbarProps:{color:"red-lighten-1"}})}finally{f.value=!1}},xe=n=>{I.value={open:!0,id:n._id,name:n.name}},De=async()=>{var n,e;try{await g.delete(`/department/${I.value.id}`),await b(),I.value.open=!1,p({text:"刪除部門成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){p({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},we=de(()=>o.value.originalData?o.value.companyId!==o.value.originalData.companyId||o.value.name!==o.value.originalData.name||o.value.departmentId!==o.value.originalData.departmentId:!0),_e=n=>{B.value=n.page,P.value=n.itemsPerPage,x.value=n.sortBy,b()},oe=Ae.debounce(()=>{b(!0)},300);return ue(U,()=>{oe()}),ue([P,x,T],()=>{b(!0)}),Se(async()=>{await le(),await b()}),$e(()=>{oe.cancel()}),(n,e)=>(w(),N(Ne,{"max-width":"1400"},{default:t(()=>[l(Q,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:t(()=>[l(C,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:t(()=>[e[16]||(e[16]=k("h3",null,"公司部門管理",-1)),re(z)?Ee((w(),N(E,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"ms-4"},null,512)),[[Le,"人數為「在職」人數"]]):H("",!0)]),_:1}),l(C,{cols:"12"},{default:t(()=>[l(Q,null,{default:t(()=>[l(C,null,{default:t(()=>[l(Q,null,{default:t(()=>[l(C,null,{default:t(()=>[l(m,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",onClick:ce},{default:t(()=>e[17]||(e[17]=[d(" 公司管理 ")])),_:1}),l(m,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",onClick:Ie},{default:t(()=>e[18]||(e[18]=[d(" 新增部門 ")])),_:1})]),_:1}),l(C,{cols:"6",sm:"4",md:"3",lg:"2"},{default:t(()=>[l(pe,{modelValue:T.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>T.value=a),e[1]||(e[1]=a=>b(!0))],items:[{name:"全部",id:""},...c.value],label:"選擇公司","item-title":"name","item-value":"id",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","items"])]),_:1}),l(C,{cols:"6",sm:"4",md:"3",class:"d-flex justify-end align-center"},{default:t(()=>[l(_,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=a=>U.value=a),label:"搜尋","append-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{cols:"12"},{default:t(()=>[l(ze,{"items-per-page":P.value,"onUpdate:itemsPerPage":e[3]||(e[3]=a=>P.value=a),"sort-by":x.value,"onUpdate:sortBy":e[4]||(e[4]=a=>x.value=a),headers:ve.value,items:ae.value,"items-length":Y.value,loading:L.value,page:B.value,"items-per-page-options":[10,20,50],search:U.value,class:"rounded-ts-lg rounded-te-lg py-3",hover:"","onUpdate:options":_e},{item:t(({item:a})=>{var u;return[k("tr",null,[k("td",null,V(a.departmentId||"尚未設定"),1),re(z)?(w(),ie("td",Me,V((u=a.companyId)==null?void 0:u.name),1)):H("",!0),k("td",null,V(a.name),1),k("td",null,V(a.memberCount||0)+" 人",1),k("td",je,[l(m,{icon:"",color:"light-blue-darken-4",variant:"plain",class:"me-2",onClick:D=>ke(a)},{default:t(()=>[l(E,null,{default:t(()=>e[19]||(e[19]=[d("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),l(m,{icon:"",color:"red-lighten-1",variant:"plain",onClick:D=>xe(a)},{default:t(()=>[l(E,null,{default:t(()=>e[20]||(e[20]=[d("mdi-delete")])),_:1})]),_:2},1032,["onClick"])])])]}),_:1},8,["items-per-page","sort-by","headers","items","items-length","loading","page","search"])]),_:1})]),_:1})]),_:1})]),_:1}),l(J,{modelValue:F.value.open,"onUpdate:modelValue":e[6]||(e[6]=a=>F.value.open=a),persistent:"",width:"600"},{default:t(()=>[l(K,{class:"rounded-lg pa-4"},{default:t(()=>[l(O,{class:"text-h6 ps-4 py-3"},{default:t(()=>e[21]||(e[21]=[d(" 公司管理 ")])),_:1}),l(R,null,{default:t(()=>[k("div",He,[(w(!0),ie(Te,null,Be(c.value,a=>(w(),N(qe,{key:a.id,class:"me-2 mb-2 pa-2",color:"blue-grey-lighten-4"},{default:t(()=>[d(V(a.companyId)+" "+V(a.name)+" ",1),l(m,{icon:"",size:"x-small",class:"ms-2",onClick:u=>fe(a)},{default:t(()=>[l(E,null,{default:t(()=>e[22]||(e[22]=[d("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),l(m,{icon:"",size:"x-small",class:"ms-1",onClick:u=>be(a)},{default:t(()=>[l(E,null,{default:t(()=>e[23]||(e[23]=[d("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024))),128))]),l(X,{onSubmit:W(ge,["prevent"])},{default:t(()=>[l(_,{modelValue:h.value.name,"onUpdate:modelValue":e[5]||(e[5]=a=>h.value.name=a),"error-messages":q.value,label:"公司名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"]),l(Z,{class:"pa-0 mt-4"},{default:t(()=>[l(G),l(m,{color:"red-lighten-1",variant:"outlined",onClick:te},{default:t(()=>e[24]||(e[24]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,class:"ms-2"},{default:t(()=>e[25]||(e[25]=[d(" 新增 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(J,{modelValue:r.value.open,"onUpdate:modelValue":e[9]||(e[9]=a=>r.value.open=a),persistent:"",width:"400"},{default:t(()=>[l(K,{class:"rounded-lg pa-4"},{default:t(()=>[l(O,{class:"text-h6 ps-4 py-3"},{default:t(()=>e[26]||(e[26]=[d(" 編輯公司 ")])),_:1}),l(R,null,{default:t(()=>[l(X,{onSubmit:W(ye,["prevent"])},{default:t(()=>[l(_,{modelValue:r.value.companyId,"onUpdate:modelValue":e[7]||(e[7]=a=>r.value.companyId=a),label:"公司編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"]),l(_,{modelValue:r.value.name,"onUpdate:modelValue":e[8]||(e[8]=a=>r.value.name=a),"error-messages":A.value,label:"公司名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"]),l(Z,{class:"pa-0 mt-4"},{default:t(()=>[l(G),l(m,{color:"red-lighten-1",variant:"outlined",onClick:ne},{default:t(()=>e[27]||(e[27]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,class:"ms-2"},{default:t(()=>e[28]||(e[28]=[d(" 修改 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(J,{modelValue:v.value.open,"onUpdate:modelValue":e[13]||(e[13]=a=>v.value.open=a),persistent:"",width:"400"},{default:t(()=>[l(K,{class:"rounded-lg pa-4"},{default:t(()=>[l(O,{class:"text-h6 ps-4 py-3"},{default:t(()=>[d(V(v.value.id?"編輯部門":"新增部門"),1)]),_:1}),l(R,null,{default:t(()=>[l(X,{onSubmit:W(Ce,["prevent"])},{default:t(()=>[v.value.id?(w(),N(_,{key:0,modelValue:o.value.departmentId,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.departmentId=a),label:"部門編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"])):H("",!0),l(pe,{modelValue:o.value.companyId,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.companyId=a),items:c.value,label:"選擇公司","item-title":"name","item-value":"_id",required:"",variant:"outlined",density:"compact",class:"mb-4","error-messages":$.value},null,8,["modelValue","items","error-messages"]),l(_,{modelValue:o.value.name,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.name=a),label:"部門名稱",required:"",variant:"outlined",density:"compact","error-messages":S.value},null,8,["modelValue","error-messages"]),l(Z,{class:"pa-0 mt-4"},{default:t(()=>[l(G),l(m,{color:"red-lighten-1",variant:"outlined",onClick:M},{default:t(()=>e[29]||(e[29]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,disabled:v.value.id?!we.value:!1,class:"ms-2"},{default:t(()=>[d(V(v.value.id?"修改":"新增"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(me,{modelValue:y.value.open,"onUpdate:modelValue":e[14]||(e[14]=a=>y.value.open=a),title:"確認刪除公司",message:`確定要刪除公司「${y.value.name}」嗎？此操作無法復原。`,"expected-name":y.value.name,"input-label":"公司名稱",onConfirm:Ve},null,8,["modelValue","message","expected-name"]),l(me,{modelValue:I.value.open,"onUpdate:modelValue":e[15]||(e[15]=a=>I.value.open=a),title:"確認刪除部門",message:`確定要刪除部門「${I.value.name}」嗎？此操作無法復原。`,"expected-name":I.value.name,"input-label":"部門名稱",onConfirm:De},null,8,["modelValue","message","expected-name"])]),_:1}))}},oa=Pe(Ke,[["__scopeId","data-v-71515816"]]);export{oa as default};
