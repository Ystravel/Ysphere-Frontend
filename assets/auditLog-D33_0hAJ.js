import{_ as Ae,o as Q,Z as Le,P as Ne,x as c,z as ie,A as Oe,aj as h,c as l,a4 as n,an as Pe,U as W,ao as je,a1 as qe,a2 as D,ae as ce,af as ze,a9 as $,ah as pe,a8 as k,ap as ge,a7 as F,H as me,ai as f,K as X,ab as d,aa as E,ak as fe,aq as He,ar as Fe,a6 as Ee}from"./index-CwvhLw15.js";import{l as ve}from"./lodash-DHyxJ22h.js";import{V as Be}from"./VContainer-BMqPcRAG.js";import{V as _,a as p}from"./VRow-CAz54Qec.js";import{V as Ie}from"./VAutocomplete-Bp847Yez.js";import{V as ye}from"./VTooltip-COJdjokX.js";import{V as be,a as Ke}from"./VDataTableServer-pw4S_HOu.js";import{V as N}from"./VDivider-CtBGMpHm.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-BWooNMST.js";import"./VCheckboxBtn-BKJABbv8.js";const ee={1:"永信台北",2:"永信桃園",3:"永信台中",4:"永信高雄",5:"好漾台北",6:"好漾台中",7:"銳皇國際",8:"集睿創映"},Re={key:0},Ye={key:1},Ze={key:2},Ge={key:3,class:"py-3"},Je={class:"text-center"},Qe={class:"d-flex flex-column gap-4"},We={class:"list-content"},Xe={class:"list-content"},et={class:"list-content"},tt={class:"list-content"},at={class:"list-content"},lt={key:0,class:"list-content"},st={class:"change-list"},rt={key:1},nt={__name:"auditLog",setup(ot){const he=Q(()=>C.value?"default":"small"),B=Le(),{apiAuth:O}=je(),{smAndUp:C,mdAndUp:te,lgAndUp:ae}=Ne(),V=c([]),y=c([]),K=c(!1),R=c(!1),P=c(""),S=c(""),j=c(!1),Y=c([]),M=c(1),U=c(10),Z=c(0),A=c([{key:"createdAt",order:"desc"}]),De={class:"header-bg"},r=c({operatorId:null,targetId:null,action:"",targetModel:"",startDate:null,endDate:null}),q=c(!1),w=c(null),we=e=>{w.value=e,q.value=!0},$e=[{title:"創建",value:"創建"},{title:"修改",value:"修改"},{title:"刪除",value:"刪除"}],ke=[{title:"員工資料",value:"users"},{title:"部門資料",value:"departments"},{title:"設備資料",value:"assets"},{title:"臨時員工資料",value:"tempUsers"}],G=e=>({users:"員工資料",departments:"部門資料",assets:"資產資料",tempUsers:"臨時員工資料"})[e]||e,le=e=>{if(!e)return"";if(typeof e=="object"){if(e.name&&e.departmentId)return`${e.name} (${e.departmentId})`;if(e.name&&e.userId)return`${e.name} (${e.userId})`}return e},Ve={name:"姓名",englishName:"英文名",email:"電子郵件",cellphone:"手機號碼",extNumber:"分機號碼",printNumber:"列印編號",department:"部門",companyId:"公司",company:"公司",companyName:"公司名稱",jobTitle:"職稱",role:"權限",employmentStatus:"任職狀態",gender:"性別",guideLicense:"領隊證",salary:"薪資",birthDate:"生日",hireDate:"入職日期",resignationDate:"離職日期",emergencyName:"緊急聯絡人",emergencyCellphone:"緊急聯絡電話",emergencyRelationship:"緊急聯絡人關係",permanentAddress:"戶籍地址",contactAddress:"聯絡地址",IDNumber:"身分證號碼",userId:"員工編號",departmentId:"部門編號",note:"備註",description:"描述",cowellAccount:"科威帳號",cowellPassword:"科威密碼"},z=[{title:"操作時間",align:"start",sortable:!0,key:"createdAt"},{title:"操作人員",align:"start",sortable:!0,key:"operatorId"},{title:"資料類型",align:"start",sortable:!0,key:"targetModel"},{title:"動作",align:"start",sortable:!0,key:"actionType"},{title:"操作對象",align:"start",sortable:!0,key:"targetId"},{title:"異動內容",align:"start",sortable:!1,key:"changes"},{title:"查看",align:"center",sortable:!1,key:"actions"}],xe=Q(()=>C.value?te.value?ae.value?z:z.filter(e=>e.key!=="changes"):z.filter(e=>["createdAt","operatorId","targetModel","actionType","actions"].includes(e.key)):z.filter(e=>["createdAt","targetModel","actions"].includes(e.key))),_e=ve.debounce(async e=>{K.value=!0;try{const{data:t}=await O.get("/user/suggestions",{params:{search:e}});if(t.success)V.value=t.result;else if(e){const s={name:e,userId:e};V.value=[s],r.value.operatorId=s}else V.value=[]}catch(t){console.error("搜索操作人員失敗:",t),V.value=[]}finally{K.value=!1}},300),Ce=ve.debounce(async e=>{R.value=!0;try{let t;switch(H.value){case"users":if(t=await O.get("/user/suggestions",{params:{search:e}}),t.data.success)y.value=t.data.result.map(s=>({_id:s._id,name:s.name,userId:s.userId}));else if(e){const s={name:e,userId:e};y.value=[s],r.value.targetId=s}else y.value=[];break;case"departments":if(t=await O.get("/department/all",{params:{search:e,searchFields:["name","departmentId"]}}),t.data.success)y.value=t.data.result.data.map(s=>({_id:s._id,name:s.name,departmentId:s.departmentId}));else if(e){const s={name:e,departmentId:e};y.value=[s],r.value.targetId=s}else y.value=[];break}}catch(t){console.error("搜尋被操作對象失敗:",t),y.value=[]}finally{R.value=!1}},300),se=()=>{var e;P.value="",V.value=[],((e=r.value.operatorId)==null?void 0:e.name)!==P.value&&(r.value.operatorId=null)},re=()=>{var e;S.value="",y.value=[],((e=r.value.targetId)==null?void 0:e.name)!==S.value&&(r.value.targetId=null)},ne=e=>{if(!e)return"-";const t=new Date(e),s=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())} ${s(t.getHours())}:${s(t.getMinutes())}`},Te=e=>{if(!e)return"(無)";const t=new Date(e),s=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}`},oe=e=>{var t,s,a;return e?(t=e.operator)!=null&&t.name&&((s=e.operator)!=null&&s.userId)?`${e.operator.name} (${e.operator.userId})`:(a=e.operatorInfo)!=null&&a.name?`${e.operatorInfo.name}${e.operatorInfo.userId?` (${e.operatorInfo.userId})`:""}`:"系統":"-"},de=e=>{var t,s,a,o,g,u,i,m,I,T;if(!e)return"-";if(e.targetData)switch(e.targetModel){case"users":{const b=e.targetData.name||"-",v=e.targetData.userId?` (${e.targetData.userId})`:"";return`${b}${v}`}case"departments":{const b=e.targetData.name||"-",v=e.targetData.departmentId?` (${e.targetData.departmentId})`:"",x=ee[e.targetData.companyId]||"";return`${b}${v}${x?` - ${x}`:""}`}default:return`${e.targetData.name||"-"}`}if(e.targetInfo)switch(e.targetModel){case"users":{const b=e.targetInfo.name||"-",v=e.targetInfo.userId?` (${e.targetInfo.userId})`:"";return`${b}${v}`}case"departments":{const b=e.targetInfo.name||"-",v=e.targetInfo.departmentId?` (${e.targetInfo.departmentId})`:"",x=ee[e.targetInfo.companyId]||"";return`${b}${v}${x?` - ${x}`:""}`}default:return`${e.targetInfo.name||"-"}`}if(e.changes)switch(e.targetModel){case"users":{const b=e.action==="刪除"?((t=e.changes.name)==null?void 0:t.from)||"-":((s=e.changes.name)==null?void 0:s.to)||"-",v=e.action==="刪除"?((a=e.changes.userId)==null?void 0:a.from)||"":((o=e.changes.userId)==null?void 0:o.to)||"";return`${b}${v?` (${v})`:""}`}case"departments":{const b=e.action==="刪除"?((g=e.changes.name)==null?void 0:g.from)||"-":((u=e.changes.name)==null?void 0:u.to)||"-",v=e.action==="刪除"?((i=e.changes.departmentId)==null?void 0:i.from)||"":((m=e.changes.departmentId)==null?void 0:m.to)||"",x=e.action==="刪除"?((I=e.changes.companyId)==null?void 0:I.from)||"":((T=e.changes.companyId)==null?void 0:T.to)||"",ue=ee[x]||"";return`${b}${v?` (${v})`:""}${ue?` - ${ue}`:""}`}default:return"-"}return"-"},Se=(e,t="")=>{if(e==="name"){if(t==="users")return"姓名";if(t==="departments")return"部門名稱"}return Ve[e]||e},J=e=>{if(!(e!=null&&e.changes))return[];const t=[],s=new Set;return Object.entries(e.changes).forEach(([a,o])=>{if(!o||typeof o!="object"||!("from"in o)&&!("to"in o)||s.has(a))return;const g=I=>!I||I==="(無)"?"(無)":typeof I=="string"&&I.includes("T")?Te(I):I,u=g(o.from),i=g(o.to),m=Se(a,e.targetModel);if(e.action==="創建"){i!=="(無)"&&(t.push(`${m}: ${i}`),s.add(a));return}u!==i&&m&&(t.push(`${m}: ${u} → ${i}`),s.add(a))}),e.action==="創建"&&t.length===0&&t.push(`新增${G(e.targetModel)}`),t},Me=()=>{r.value={operatorId:null,targetId:null,action:"",targetModel:"",startDate:null,endDate:null},se(),re(),L()},H=Q(()=>r.value.targetModel),L=async()=>{var e,t,s,a,o,g;if(r.value.startDate&&r.value.endDate){const u=new Date(r.value.startDate),i=new Date(r.value.endDate);if(u>i){B({text:"結束日期不能早於開始日期",snackbarProps:{color:"warning"}});return}}j.value=!0;try{const u={page:M.value,itemsPerPage:U.value,sortBy:((e=A.value[0])==null?void 0:e.key)||"createdAt",sortOrder:((t=A.value[0])==null?void 0:t.order)||"desc"};if(r.value.startDate){const m=new Date(r.value.startDate);m.setHours(0,0,0,0),u.startDate=m.toISOString()}if(r.value.endDate){const m=new Date(r.value.endDate);m.setHours(23,59,59,999),u.endDate=m.toISOString()}(s=r.value.operatorId)!=null&&s._id&&(u.operatorId=r.value.operatorId._id),(a=r.value.targetId)!=null&&a._id&&(u.targetId=r.value.targetId._id),r.value.action&&(u.action=r.value.action),r.value.targetModel&&(u.targetModel=r.value.targetModel);const i=await O.get("/auditlog/all",{params:u});if(i.data.success){const{data:m,totalItems:I}=i.data.result;Y.value=m,Z.value=I;const T=Math.ceil(I/U.value);T>0&&M.value>T&&(M.value=T,await L())}else throw new Error(i.data.message)}catch(u){console.error("搜尋失敗:",u),B({text:((g=(o=u==null?void 0:u.response)==null?void 0:o.data)==null?void 0:g.message)||"搜尋時發生錯誤",snackbarProps:{color:"error"}}),Y.value=[],Z.value=0}finally{j.value=!1}},Ue=async({page:e,itemsPerPage:t,sortBy:s})=>{M.value=e,U.value=t,(s==null?void 0:s.length)>0&&(A.value=s),await L()};return ie([()=>r.value.startDate,()=>r.value.endDate],([e,t])=>{if(e&&t){const s=new Date(e),a=new Date(t);s>a&&(B({text:"結束日期不能早於開始日期",snackbarProps:{color:"warning"}}),r.value.endDate=null)}}),ie(()=>r.value.targetModel,e=>{r.value.targetId=null,S.value="",y.value=[]}),Oe(async()=>{await L()}),(e,t)=>{const s=qe("v-date-input");return D(),h(W,null,[l(Be,{"max-width":"2500"},{default:n(()=>[l(_,{class:"pt-md-5"},{default:n(()=>[l(p,{cols:"12",lg:"4",xl:"3"},{default:n(()=>[l(_,null,{default:n(()=>[l(p,{cols:"12",class:"mt-1 px-lg-10"},{default:n(()=>[l(ce,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-4 px-sm-4 px-xl-8"},{default:n(()=>[l(ze,{class:"font-weight-bold d-flex align-center"},{default:n(()=>t[14]||(t[14]=[$(" 搜尋條件 ")])),_:1}),l(pe,{class:"pa-2"},{default:n(()=>[l(_,null,{default:n(()=>[l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(Ie,{modelValue:r.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=a=>r.value.operatorId=a),"search-input":P.value,"onUpdate:searchInput":t[1]||(t[1]=a=>P.value=a),items:V.value,loading:K.value,label:"操作人員","return-object":"","item-props":a=>({title:`${a.name} (${a.userId})`,value:a}),variant:"outlined",density:"compact","hide-details":"",clearable:"",creatable:"","create-filter":`(item, queryText, itemText) =>
    item.name.toLowerCase().indexOf(queryText.toLowerCase()) > -1 ||
    item.userId.toLowerCase().indexOf(queryText.toLowerCase()) > -1`,"onUpdate:search":k(_e),"onClick:clear":se,onCreate:t[2]||(t[2]=a=>{const o={name:a,userId:a};V.value.value.push(o),r.value.value.operatorId=o})},ge({selection:n(({item:a})=>{var o;return[$(f((o=a==null?void 0:a.props)==null?void 0:o.title),1)]}),_:2},[k(C)?{name:"append-inner",fn:n(()=>[l(ye,{location:"top","close-delay":"200"},{activator:n(({props:a})=>[l(F,me(a,{icon:"mdi-information",size:"18"}),null,16)]),default:n(()=>[t[15]||(t[15]=$(" 輸入員編、姓名查詢 "))]),_:1})]),key:"0"}:void 0]),1032,["modelValue","search-input","items","loading","item-props","onUpdate:search"])]),_:1}),l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(be,{modelValue:r.value.targetModel,"onUpdate:modelValue":t[3]||(t[3]=a=>r.value.targetModel=a),items:ke,label:"資料類型","item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(Ie,{modelValue:r.value.targetId,"onUpdate:modelValue":t[4]||(t[4]=a=>r.value.targetId=a),"search-input":S.value,"onUpdate:searchInput":t[5]||(t[5]=a=>S.value=a),items:y.value,loading:R.value,label:H.value?"操作對象":"操作對象( 請先選擇資料類型 )",disabled:!H.value,"return-object":"","item-props":a=>({title:le(a),value:a}),variant:"outlined",density:"compact","hide-details":"",clearable:"",creatable:"","create-filter":`(item, queryText, itemText) =>
    item.name.toLowerCase().indexOf(queryText.toLowerCase()) > -1 ||
    (item.userId && item.userId.toLowerCase().indexOf(queryText.toLowerCase()) > -1) ||
    (item.departmentId && item.departmentId.toLowerCase().indexOf(queryText.toLowerCase()) > -1)`,"onUpdate:search":k(Ce),"onClick:clear":re,onCreate:t[6]||(t[6]=a=>{let o;switch(H.value.value){case"users":o={name:a,userId:a};break;case"departments":o={name:a,departmentId:a};break}y.value.value.push(o),r.value.value.targetId=o})},ge({selection:n(({item:a})=>[$(f(le(a.props.value)),1)]),_:2},[k(C)?{name:"append-inner",fn:n(()=>[l(ye,{location:"top","close-delay":"200"},{activator:n(({props:a})=>[l(F,me(a,{icon:"mdi-information",size:"18"}),null,16)]),default:n(()=>[t[16]||(t[16]=$(" 輸入員編、姓名、部門編號、部門名稱、設備編號、設備名稱查詢 "))]),_:1})]),key:"0"}:void 0]),1032,["modelValue","search-input","items","loading","label","disabled","item-props","onUpdate:search"])]),_:1}),l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(be,{modelValue:r.value.action,"onUpdate:modelValue":t[7]||(t[7]=a=>r.value.action=a),items:$e,label:"操作類型","item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(s,{modelValue:r.value.startDate,"onUpdate:modelValue":t[8]||(t[8]=a=>r.value.startDate=a),label:"開始日期","prepend-icon":"",variant:"outlined",density:"compact","hide-details":"",clearable:"","cancel-text":"取消","ok-text":"確認"},null,8,["modelValue"])]),_:1}),l(p,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[l(s,{modelValue:r.value.endDate,"onUpdate:modelValue":t[9]||(t[9]=a=>r.value.endDate=a),label:"結束日期","prepend-icon":"",variant:"outlined",density:"compact","hide-details":"",clearable:"","cancel-text":"取消","ok-text":"確認",min:r.value.startDate},null,8,["modelValue","min"])]),_:1})]),_:1}),l(_,null,{default:n(()=>[l(p,{cols:"12",class:"d-flex justify-end gap-2"},{default:n(()=>[l(_,{class:"d-flex justify-space-between"},{default:n(()=>[l(p,{cols:"3"},{default:n(()=>[l(X,{color:"grey",width:"40",block:"",onClick:Me},{default:n(()=>[l(F,null,{default:n(()=>t[17]||(t[17]=[$("mdi-refresh")])),_:1})]),_:1})]),_:1}),l(p,{cols:"9",class:"ps-0"},{default:n(()=>[l(X,{color:"blue-grey-darken-1","prepend-icon":"mdi-magnify",loading:j.value,block:"",onClick:L},{default:n(()=>t[18]||(t[18]=[$(" 搜尋 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(p,{cols:"12",lg:"8",xl:"9",class:"px-6 ps-lg-4 pe-lg-12 mb-6"},{default:n(()=>[l(_,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-4 px-md-10 mt-1 bg-white"},{default:n(()=>[l(p,{cols:"12",class:"ps-4 pb-sm-6"},{default:n(()=>t[19]||(t[19]=[d("h3",null,"異動紀錄",-1)])),_:1}),l(p,{cols:"12"},{default:n(()=>[l(Ke,{"items-per-page":U.value,"onUpdate:itemsPerPage":t[10]||(t[10]=a=>U.value=a),"sort-by":A.value,"onUpdate:sortBy":t[11]||(t[11]=a=>A.value=a),items:Y.value,headers:xe.value,loading:j.value,"items-length":Z.value,"items-per-page-options":[10,20,50,100],page:M.value,"header-props":De,hover:"",density:"compact",class:"rounded-ts-lg rounded-te-lg","onUpdate:options":Ue},{item:n(({item:a,index:o})=>[d("tr",{class:He({"odd-row":o%2===0,"even-row":o%2!==0})},[d("td",null,f(ne(a.createdAt)),1),k(C)?(D(),h("td",Re,f(oe(a)),1)):E("",!0),d("td",null,f(G(a.targetModel)),1),k(C)?(D(),h("td",Ye,f(a.action),1)):E("",!0),k(te)?(D(),h("td",Ze,f(de(a)),1)):E("",!0),k(ae)?(D(),h("td",Ge,[(D(!0),h(W,null,fe(J(a),(g,u)=>(D(),h("div",{key:u},f(g),1))),128))])):E("",!0),d("td",Je,[l(F,{icon:"mdi-book-open-variant-outline",color:"blue-grey-darken-3",size:"small",class:"my-4",onClick:g=>we(a)},null,8,["onClick"])])],2)]),_:1},8,["items-per-page","sort-by","items","headers","loading","items-length","page"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(Pe,{modelValue:q.value,"onUpdate:modelValue":t[13]||(t[13]=a=>q.value=a),width:"600"},{default:n(()=>[l(ce,{class:"pa-4"},{default:n(()=>[t[27]||(t[27]=d("div",{class:"ps-6 pt-4 pb-1 pb-sm-3 card-title"}," 異動詳細資料 ",-1)),l(pe,null,{default:n(()=>[l(_,null,{default:n(()=>[l(p,{cols:"12"},{default:n(()=>{var a,o,g;return[d("div",Qe,[d("div",null,[t[20]||(t[20]=d("div",{class:"text-grey-darken-1 list-title"}," 操作時間 ",-1)),d("div",We,f(ne((a=w.value)==null?void 0:a.createdAt)),1)]),l(N,{class:"my-2"}),d("div",null,[t[21]||(t[21]=d("div",{class:"text-grey-darken-1 list-title"}," 操作人員 ",-1)),d("div",Xe,f(oe(w.value)),1)]),l(N,{class:"my-2"}),d("div",null,[t[22]||(t[22]=d("div",{class:"text-grey-darken-1 list-title"}," 操作對象 ",-1)),d("div",et,f(de(w.value)),1)]),l(N,{class:"my-2"}),d("div",null,[t[23]||(t[23]=d("div",{class:"text-grey-darken-1 list-title"}," 操作類型 ",-1)),d("div",tt,f((o=w.value)==null?void 0:o.action),1)]),l(N,{class:"my-2"}),d("div",null,[t[24]||(t[24]=d("div",{class:"text-grey-darken-1 list-title"}," 資料類型 ",-1)),d("div",at,f(G((g=w.value)==null?void 0:g.targetModel)),1)]),l(N,{class:"my-2"}),d("div",null,[t[25]||(t[25]=d("div",{class:"text-grey-darken-1 list-title"}," 異動內容 ",-1)),J(w.value).length>0?(D(),h("div",lt,[d("ul",st,[(D(!0),h(W,null,fe(J(w.value),(u,i)=>(D(),h("li",{key:i,class:"py-2"},f(u),1))),128))])])):(D(),h("div",rt," 無異動內容 "))])])]}),_:1})]),_:1})]),_:1}),l(Fe,null,{default:n(()=>[l(Ee),l(X,{color:"grey-darken-1",variant:"outlined",size:he.value,onClick:t[12]||(t[12]=a=>q.value=!1)},{default:n(()=>t[26]||(t[26]=[$(" 關閉 ")])),_:1},8,["size"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}},bt=Ae(nt,[["__scopeId","data-v-9ac2c755"]]);export{bt as default};
