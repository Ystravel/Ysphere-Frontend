import{a0 as Fe,a2 as Be,P as Me,o as ae,x as d,z as qe,A as se,as as Ee,a7 as h,a8 as a,aE as Ne,a6 as k,c as l,af as i,K as b,ad as r,ac as u,ag as oe,ab as V,ae as re,aA as K,ax as x,an as L,ao as W,U as ie,ai as O,a9 as he,am as ne,ap as Le,aC as ue,aa as de,aD as me,V as Oe}from"./index-CDGlHwuR.js";import{c as je,a as D,u as Re,b as S}from"./index.esm-BElVrIHK.js";import{V as Ge,C as Je}from"./ConfirmDeleteDialog-DjNbGNm6.js";import{V as He}from"./VContainer-PrWo7SB4.js";import{a as m,V as I}from"./VRow-c2sxsQB6.js";import{V as Ke}from"./VDataTableServer-DGJes_T6.js";import{V as We}from"./VForm-Bf7GBivV.js";import{a as pe}from"./VPagination-CDeKvYwQ.js";import{V as Qe}from"./VTextarea-BHchgcfJ.js";import{V as Q}from"./VDivider-BWazCLQ0.js";import{T as ce}from"./index-BENQjCqP.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VCheckboxBtn-D4-rOcoU.js";import"./VList-DQb7xxY0.js";import"./VTooltip-DN4CBF_q.js";const Xe={class:"ms-1"},Ye={key:1},Ze={class:"card-title ps-4 py-3"},_e={class:"d-flex flex-column gap-4"},el={style:{"line-height":"2","font-size":"14px"}},ll={__name:"ITService",setup(tl){const{apiAuth:z}=Ne(),f=Be(),{smAndUp:X,mdAndUp:ve,lgAndUp:ge,xlAndUp:fe}=Me(),w=ae(()=>X.value?"default":"small"),ye={class:"header-bg"},v=d([]),T=d(!1),j=d(null),U=d([]),g=d([]),be=d([]),$=d(!1),ke=s=>{j.value=s,T.value=!0},A=[{title:"維修編號",align:"start",key:"ticketId",sortable:!0},{title:"標題",align:"start",key:"title",sortable:!0},{title:"類別",align:"start",key:"category",sortable:!0},{title:"優先度",align:"start",key:"priority",sortable:!0},{title:"狀態",align:"start",key:"status",sortable:!0},{title:"地點",align:"start",key:"location",sortable:!0},{title:"圖片",align:"start",key:"attachments",sortable:!1},{title:"問題描述",align:"start",key:"description",sortable:!1},{title:"操作",align:"center",key:"actions",sortable:!1,render:s=>s.status==="待處理"?"mdi-pencil":""}],Ve=ae(()=>fe.value?A:ge.value?A.filter(s=>s.key!=="attachments"):ve.value?A.filter(s=>!["attachments","category","priority"].includes(s.key)):A.filter(s=>["ticketId","title","status","actions"].includes(s.key))),R=d(10),F=d(1),C=d([]),Y=d([]),Z=d(0),G=d(!1),J=d(""),xe=["硬體問題","軟體問題","網路問題","帳號權限","其他"],Ie=["低","中","高","緊急"],p=d({open:!1,id:""}),ze=d({title:"",category:"",priority:"中",location:"",description:"",attachments:[]}),c=d([]),we=s=>({待處理:"grey-darken-1",處理中:"blue",待確認:"orange-darken-1",已完成:"green",已取消:"red"})[s]||"grey",Ce=s=>({低:"green",中:"blue",高:"orange-darken-1",緊急:"red"})[s]||"grey",P=async()=>{var s,e;G.value=!0;try{const{data:o}=await z.get("/serviceTicket/my-tickets",{params:{page:F.value,limit:R.value,sort:C.value.length?`${C.value[0].order==="desc"?"-":""}${C.value[0].key}`:"-createdAt",search:J.value}});Y.value=o.result.data,Z.value=o.result.total}catch(o){console.error("獲取維修請求失敗:",o),f({text:((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||"獲取維修請求失敗",snackbarProps:{color:"error"}})}finally{G.value=!1}},Pe=()=>{F.value=1,P()},_=s=>{if(s){if(p.value.id=s._id,s.status!=="待處理"){f({text:'只能編輯或刪除"待處理"狀態的維修請求',snackbarProps:{color:"error"}});return}B.value.value=s.title||"",M.value.value=s.category||"",q.value.value=s.priority||"",E.value.value=s.location||"",N.value.value=s.description||"",console.log("從後端獲取的 attachments:",s.attachments);const e=(s.attachments||[]).map(o=>(o.publicId||console.warn("缺少 publicId 的附件:",o),{url:o.url||"",publicId:o.publicId||null,isExisting:!0}));v.value=e,U.value=[...e],console.log("格式化後的 attachments:",v.value)}else p.value.id=null,le(),v.value=[],U.value=[];g.value=[],c.value=[],p.value.open=!0},ee=()=>{p.value.open=!1,le(),c.value=[],v.value=[],g.value=[],be.value=[],U.value=[]},De=async()=>{var s,e;try{await z.delete(`/serviceTicket/${j.value._id}`),f({text:"維修請求刪除成功",snackbarProps:{color:"success"}}),P(),T.value=!1}catch(o){console.error("刪除維修請求失敗:",o),f({text:((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"error"}})}},Se=s=>{if(s>=0&&s<v.value.length){const e=v.value.splice(s,1)[0];if(console.log("要移除的附件:",e),e!=null&&e.publicId){const o=e.publicId.includes("tickets/")?e.publicId:`tickets/${e.publicId}`;console.log("待刪除的 fullPublicId:",o),console.log("當前的 tempDeletedImages:",g.value),g.value.includes(o)||(g.value.push(o),console.log("更新後的 tempDeletedImages:",g.value))}}},Te=je({title:D().required("請輸入標題"),category:D().required("請選擇類別").oneOf(["硬體問題","軟體問題","網路問題","帳號權限","其他"],"請選擇有效的類別"),priority:D().default("中").oneOf(["低","中","高","緊急"],"請選擇有效的優先程度"),location:D().required("請輸入地點"),description:D().required("請輸入問題描述")}),{handleSubmit:Ue,isSubmitting:H,resetForm:le}=Re({validationSchema:Te,initialValues:{title:"",category:"",priority:"中",location:"",description:""}}),B=S("title"),M=S("category"),q=S("priority"),E=S("location"),N=S("description"),$e=Ue(async s=>{var e,o,t;try{if(p.value.id){if(g.value.length>0){console.log("正在刪除圖片，數量:",g.value.length);const n=g.value.map(y=>{const te=y.split("tickets/")[1];return console.log(`準備刪除圖片: ${te}`),z.delete(`/serviceTicket/${p.value.id}/images/${te}`)});await Promise.all(n),await new Promise(y=>setTimeout(y,500))}if(console.log("正在更新請求基本資料"),await z.patch(`/serviceTicket/${p.value.id}/edit`,s),c.value.length>0){console.log("正在上傳新圖片，數量:",c.value.length);const n=new FormData;c.value.forEach(y=>n.append("images",y)),await z.post(`/serviceTicket/${p.value.id}/images`,n,{headers:{"Content-Type":"multipart/form-data"}})}}else{console.log("正在創建新維修請求");const n=new FormData;n.append("title",s.title),n.append("category",s.category),n.append("priority",s.priority),n.append("location",s.location),n.append("description",s.description),c.value.length>0&&(console.log("附加上傳圖片到新請求，數量:",c.value.length),c.value.forEach(y=>n.append("images",y))),await z.post("/serviceTicket",n,{headers:{"Content-Type":"multipart/form-data"}})}f({text:`維修請求${p.value.id?"更新":"建立"}成功`,snackbarProps:{color:"teal-lighten-1"}}),ee(),P()}catch(n){console.error("提交失敗:",n),console.error("錯誤詳情:",(e=n.response)==null?void 0:e.data),f({text:((t=(o=n.response)==null?void 0:o.data)==null?void 0:t.message)||"操作失敗",snackbarProps:{color:"error"}})}}),Ae=s=>s?(p.value.id?v.value.filter(t=>!t.isNew).length:0)+s.length>4?(f({text:"最多只能上傳4張圖片",snackbarProps:{color:"warning"}}),!1):s.some(t=>t.size>2*1024*1024)?(f({text:"圖片大小不能超過2MB",snackbarProps:{color:"warning"}}),!1):!0:!0;return qe(c,s=>{if(!Ae(s)){c.value=[];return}const e=s.map(o=>({url:URL.createObjectURL(o),publicId:o.name,isExisting:!1}));console.log("新上傳的圖片:",e),v.value=[...U.value.filter(o=>{const t=o.publicId.includes("tickets/")?o.publicId:`tickets/${o.publicId}`;return!g.value.includes(t)}),...e],console.log("更新後的圖片列表:",v.value)}),se(()=>{P()}),se(()=>{const s=localStorage.getItem("itServiceDialogState");if(s){const{form:e,dialogId:o}=JSON.parse(s);ze.value=e,p.value.id=o,p.value.open=!0}}),Ee(()=>{localStorage.removeItem("itServiceDialogState")}),(s,e)=>(k(),h(He,{"max-width":"2000"},{default:a(()=>{var o;return[l(I,{class:"elevation-4 rounded-lg py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:a(()=>[l(m,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:a(()=>[e[17]||(e[17]=i("h3",null," IT維修服務 ",-1)),l(b,{size:"x-small",color:"grey-darken-1",class:"ms-4",elevation:"1",onClick:e[0]||(e[0]=t=>$.value=!0)},{default:a(()=>e[16]||(e[16]=[r(" 使用說明 ")])),_:1})]),_:1}),l(m,{cols:"12"},{default:a(()=>[l(I,null,{default:a(()=>[l(m,null,{default:a(()=>[l(I,null,{default:a(()=>[l(m,null,{default:a(()=>[l(b,{"prepend-icon":"mdi-wrench-outline",color:"blue-grey-darken-2",variant:"outlined",onClick:e[1]||(e[1]=t=>_(null))},{default:a(()=>e[18]||(e[18]=[r(" 我要報修 ")])),_:1})]),_:1}),l(m,{cols:"6",md:"4",lg:"3",xl:"2",class:"d-flex justify-end align-center"},{default:a(()=>[u(X)?oe((k(),h(V,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"me-4"},null,512)),[[ce,"可搜尋維修編號、標題、地點、問題描述","start"]]):re("",!0),l(K,{modelValue:J.value,"onUpdate:modelValue":e[2]||(e[2]=t=>J.value=t),label:"搜尋","append-inner-icon":"mdi-magnify","base-color":"#666",color:"blue-grey-darken-3",variant:"outlined",density:"compact","hide-details":"",clearable:"",onInput:Pe},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(m,{cols:"12"},{default:a(()=>[l(Ke,{"items-per-page":R.value,"onUpdate:itemsPerPage":e[3]||(e[3]=t=>R.value=t),"sort-by":C.value,"onUpdate:sortBy":e[4]||(e[4]=t=>C.value=t),page:F.value,"onUpdate:page":e[5]||(e[5]=t=>F.value=t),headers:Ve.value,items:Y.value,loading:G.value,"items-length":Z.value,"items-per-page-options":[10,20,50],"header-props":ye,hover:"",density:"compact",class:"rounded-ts-lg rounded-te-lg py-3","onUpdate:options":P},{"item.status":a(({item:t})=>[l(x,{color:we(t.status),variant:"outlined",size:"small",label:""},{default:a(()=>[r(L(t.status),1)]),_:2},1032,["color"])]),"item.priority":a(({item:t})=>[l(x,{color:Ce(t.priority),size:"small",variant:"outlined"},{default:a(()=>[r(L(t.priority),1)]),_:2},1032,["color"])]),"item.attachments":a(({item:t})=>[t.attachments&&t.attachments.length?(k(),W(ie,{key:0},[l(V,{icon:"mdi-image-multiple",color:"blue-grey"}),i("span",Xe," * "+L(t.attachments.length),1)],64)):(k(),W("span",Ye,"無"))]),"item.actions":a(({item:t})=>[l(I,{class:"d-flex justify-center my-1"},{default:a(()=>[l(m,{cols:"6",sm:"4",md:"3",lg:"2",class:"py-0 px-0 px-md-4"},{default:a(()=>[l(b,{icon:"",color:"light-blue-darken-4",variant:"plain",width:"28",height:"32",size:w.value,ripple:!1,disabled:t.status!=="待處理",onClick:n=>_(t)},{default:a(()=>[l(V,null,{default:a(()=>e[19]||(e[19]=[r("mdi-pencil")])),_:1})]),_:2},1032,["size","disabled","onClick"])]),_:2},1024),l(m,{cols:"6",sm:"4",md:"3",lg:"2",class:"py-0 px-0 px-md-4"},{default:a(()=>[l(b,{icon:"",color:"red-lighten-1",variant:"plain",width:"28",height:"32",size:w.value,ripple:!1,disabled:t.status!=="待處理",onClick:n=>ke(t)},{default:a(()=>[l(V,null,{default:a(()=>e[20]||(e[20]=[r("mdi-delete")])),_:1})]),_:2},1032,["size","disabled","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["items-per-page","sort-by","page","headers","items","loading","items-length"])]),_:1})]),_:1}),l(me,{modelValue:p.value.open,"onUpdate:modelValue":e[12]||(e[12]=t=>p.value.open=t),persistent:"","max-width":"600px"},{default:a(()=>[l(O,{class:"rounded-lg px-4 py-6"},{default:a(()=>[i("div",Ze,L(p.value.id?"編輯維修請求":"新增維修請求"),1),l(We,{disabled:u(H),onSubmit:he(u($e),["prevent"])},{default:a(()=>[l(ne,{class:"pa-4"},{default:a(()=>[l(I,null,{default:a(()=>[l(m,{cols:"12",sm:"6"},{default:a(()=>[l(K,{modelValue:u(B).value.value,"onUpdate:modelValue":e[6]||(e[6]=t=>u(B).value.value=t),"error-messages":u(B).errorMessage.value,label:"*標題",variant:"outlined",density:"comfortable",required:""},null,8,["modelValue","error-messages"])]),_:1}),l(m,{cols:"12",sm:"6"},{default:a(()=>[l(pe,{modelValue:u(M).value.value,"onUpdate:modelValue":e[7]||(e[7]=t=>u(M).value.value=t),"error-messages":u(M).errorMessage.value,items:xe,label:"*類別",variant:"outlined",density:"comfortable",required:""},null,8,["modelValue","error-messages"])]),_:1}),l(m,{cols:"12",sm:"6"},{default:a(()=>[l(pe,{modelValue:u(q).value.value,"onUpdate:modelValue":e[8]||(e[8]=t=>u(q).value.value=t),"error-messages":u(q).errorMessage.value,items:Ie,label:"*優先程度",variant:"outlined",density:"comfortable"},null,8,["modelValue","error-messages"])]),_:1}),l(m,{cols:"12",sm:"6"},{default:a(()=>[l(K,{modelValue:u(E).value.value,"onUpdate:modelValue":e[9]||(e[9]=t=>u(E).value.value=t),"error-messages":u(E).errorMessage.value,label:"*地點",variant:"outlined",density:"comfortable",required:""},null,8,["modelValue","error-messages"])]),_:1}),l(m,{cols:"12"},{default:a(()=>[l(Qe,{modelValue:u(N).value.value,"onUpdate:modelValue":e[10]||(e[10]=t=>u(N).value.value=t),"error-messages":u(N).errorMessage.value,label:"*問題描述",variant:"outlined",density:"comfortable",required:""},null,8,["modelValue","error-messages"])]),_:1}),v.value.length>0?(k(),h(m,{key:0,cols:"12",class:"pt-0"},{default:a(()=>[l(O,{flat:"",class:"py-2 px-4",style:{border:"1px solid #a1a1a1"}},{default:a(()=>[e[21]||(e[21]=i("div",{style:{"font-size":"15px"},class:"ps-2"}," 現有圖片 ",-1)),l(I,{class:"ma-0"},{default:a(()=>[(k(!0),W(ie,null,Le(v.value,(t,n)=>(k(),h(m,{key:t.publicId,cols:"4",md:"3",class:"pa-2"},{default:a(()=>[l(O,{class:"position-relative overflow-visible"},{default:a(()=>[l(Oe,{src:t.url,"aspect-ratio":"1",cover:""},null,8,["src"]),l(b,{icon:"",size:"x-small",elevation:"4",class:"position-absolute",style:{top:"-6px",right:"-6px"},onClick:y=>Se(n)},{default:a(()=>[l(V,{icon:"mdi-close",color:"red-darken-2"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})):re("",!0),l(m,{cols:"12"},{default:a(()=>[oe(l(Ge,{modelValue:c.value,"onUpdate:modelValue":e[11]||(e[11]=t=>c.value=t),label:"上傳圖片(僅限 JPG、PNG、WEBP格式)",variant:"underlined",multiple:"",accept:"image/*","show-size":"",rules:[t=>!t||t.length<=4||"最多只能上傳4張圖片",t=>!t||!t.some(n=>n.size>2e6)||"圖片大小不能超過2MB"]},null,8,["modelValue","rules"]),[[ce,"最多4張，每張圖片大小不超過2MB。請一次選擇所有需上傳圖片。","top"]])]),_:1})]),_:1})]),_:1}),l(ue,{class:"pa-4"},{default:a(()=>[l(de),l(b,{color:"red-lighten-1",variant:"outlined",size:w.value,onClick:ee},{default:a(()=>e[22]||(e[22]=[r(" 取消 ")])),_:1},8,["size"]),l(b,{type:"submit",color:"teal-darken-1",class:"ms-2",variant:"outlined",size:w.value,loading:u(H),disabled:u(H)},{default:a(()=>e[23]||(e[23]=[r(" 確定 ")])),_:1},8,["size","loading","disabled"])]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1},8,["modelValue"]),l(Je,{modelValue:T.value,"onUpdate:modelValue":e[13]||(e[13]=t=>T.value=t),title:"確認刪除",message:`確定要刪除 ${((o=j.value)==null?void 0:o.ticketId)||""} 嗎？此操作無法恢復。`,"confirm-button-text":"確認","confirm-button-color":"error",onConfirm:De},null,8,["modelValue","message"]),l(me,{modelValue:$.value,"onUpdate:modelValue":e[15]||(e[15]=t=>$.value=t),"max-width":"500"},{default:a(()=>[l(O,{class:"pa-4"},{default:a(()=>[e[43]||(e[43]=i("div",{class:"card-title ps-4 py-3"}," 維修服務相關說明 ",-1)),l(ne,{class:"pa-4"},{default:a(()=>[l(I,null,{default:a(()=>[l(m,{cols:"12"},{default:a(()=>[i("div",_e,[i("div",el,[e[25]||(e[25]=r(" (1) ")),e[26]||(e[26]=i("span",{style:{"font-size":"15px","font-weight":"600"}},"狀態",-1)),e[27]||(e[27]=r(" : ")),e[28]||(e[28]=i("br",null,null,-1)),e[29]||(e[29]=r("僅限狀態為")),l(x,{color:"grey-darken-1",size:"small",variant:"outlined",label:"",class:"mx-2"},{default:a(()=>e[24]||(e[24]=[r(" 待處理 ")])),_:1}),e[30]||(e[30]=r("時，才能使用「編輯 ")),l(V,{icon:"mdi-pencil",size:"small",color:"light-blue-darken-4"}),e[31]||(e[31]=r("」及「刪除")),l(V,{icon:"mdi-delete",size:"small",color:"red-lighten-1"}),e[32]||(e[32]=r("」功能。 "))]),e[41]||(e[41]=i("div",{style:{"line-height":"2","font-size":"14px"},class:"mb-2"},[r(" (2) "),i("span",{style:{"font-size":"15px","font-weight":"600"}},"優先度"),r(" : ")],-1)),i("div",null,[l(x,{color:"red",size:"small",variant:"outlined",class:"mb-2"},{default:a(()=>e[33]||(e[33]=[r(" 緊急 ")])),_:1}),e[34]||(e[34]=i("div",{class:"priority-content mt-1"},[r(" 系統完全無法運作或造成重大業務影響，需要立即處理的問題。 "),i("br"),r(" 例如：系統當機、網路完全中斷、資料遺失等。 ")],-1))]),l(Q,{class:"my-4"}),i("div",null,[l(x,{color:"orange-darken-1",size:"small",variant:"outlined",class:"mb-2"},{default:a(()=>e[35]||(e[35]=[r(" 高 ")])),_:1}),e[36]||(e[36]=i("div",{class:"priority-content mt-1"},[r(" 影響工作進行但有暫時替代方案，需要優先處理的問題。 "),i("br"),r(" 例如：系統緩慢、部分功能異常、列印設備故障等。 ")],-1))]),l(Q,{class:"my-4"}),i("div",null,[l(x,{color:"blue",size:"small",variant:"outlined",class:"mb-2"},{default:a(()=>e[37]||(e[37]=[r(" 中 ")])),_:1}),e[38]||(e[38]=i("div",{class:"priority-content mt-1"},[r(" 造成不便但不影響主要工作，可以排程處理的問題。 "),i("br"),r(" 例如：軟體安裝、設備維護、功能諮詢等。 ")],-1))]),l(Q,{class:"my-4"}),i("div",null,[l(x,{color:"green",size:"small",variant:"outlined",class:"mb-2"},{default:a(()=>e[39]||(e[39]=[r(" 低 ")])),_:1}),e[40]||(e[40]=i("div",{class:"priority-content mt-1"},[r(" 一般性問題或建議，可以安排在較空閒時處理。 "),i("br"),r(" 例如：新功能建議、系統優化、預防性維護等。 ")],-1))])])]),_:1})]),_:1})]),_:1}),l(ue,null,{default:a(()=>[l(de),l(b,{color:"grey-darken-1",variant:"outlined",size:w.value,onClick:e[14]||(e[14]=t=>$.value=!1)},{default:a(()=>e[42]||(e[42]=[r(" 關閉 ")])),_:1},8,["size"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]}),_:1}))}},bl=Fe(ll,[["__scopeId","data-v-199742ac"]]);export{bl as default};
