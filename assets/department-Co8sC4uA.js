import{_ as Pe,P as Ue,Z as Se,x as o,o as de,z as W,A as $e,ar as Ee,a2 as A,a3 as t,a1 as D,c as l,aa as x,a7 as ue,ab as Te,a6 as E,a9 as Z,K as m,a8 as d,as as w,ah as V,ai as ie,ap as Be,ad as G,ae as J,ag as O,aj as Fe,U as qe,a4 as Q,aq as X,a5 as Y,am as ee,an as ze,at as Ae}from"./index-DM_g1lqN.js";import{l as Ne}from"./lodash-DHyxJ22h.js";import{C as re}from"./ConfirmDeleteDialogWithTextField-B2TU-RvW.js";import{V as Le}from"./VContainer-D_k5L0zM.js";import{a as _,V as ae}from"./VRow-BMdiV-pl.js";import{V as me,a as Me}from"./VDataTableServer-QE4vlyyE.js";import{V as le}from"./VForm-DYahoI18.js";import{T as je}from"./index-B9ai3v2I.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-GKrwgULo.js";import"./VDivider-DhDJINfn.js";import"./VCheckboxBtn-FhQZWY81.js";import"./VTooltip-i7NJwBZi.js";const He={key:0},Ke={class:"text-center"},Re={class:"mb-8"},We={__name:"department",setup(Ze){const{smAndUp:N}=Ue(),{apiAuth:y}=ze(),r=Se(),L=o(!1),T=o(10),B=o([{key:"departmentId",order:"asc"}]),M=o(1),j=o(0),h=o(""),P=o(""),pe={class:"header-bg"},te=[{title:"部門編號",key:"departmentId",align:"start",width:"15%",sortable:!0},{title:"公司",key:"c_id.name",align:"start",width:"25%",sortable:!0},{title:"部門",key:"name",align:"start",width:"30%",sortable:!0},{title:"人數",key:"memberCount",align:"start",sortable:!0},{title:"操作",key:"actions",align:"center",sortable:!1}],ce=de(()=>N.value?te:te.filter(n=>["departmentId","name","memberCount","actions"].includes(n.key))),v=o([]),F=o({open:!1}),u=o({open:!1,_id:"",companyId:"",name:""}),b=o({open:!1,_id:"",name:""}),I=o({name:""}),U=o([]),q=o([]),H=o([]),p=o({open:!1,id:null}),k=o({open:!1,id:"",name:""}),s=o({c_id:"",name:"",departmentId:"",hasChanges:!0}),S=o([]),$=o([]),f=o(!1),ne=async()=>{try{const{data:n}=await y.get("/company/all");n.success&&(v.value=n.result)}catch{r({text:"載入公司列表失敗",snackbarProps:{color:"red-lighten-1"}})}},g=async(n=!1)=>{n&&(M.value=1),L.value=!0;try{const e={companyId:P.value||null,search:h.value||null},{data:a}=await y.get("/department/all",{params:e});a.success&&(H.value=a.result,j.value=a.result.length||0)}catch{r({text:"載入部門列表失敗",snackbarProps:{color:"red-lighten-1"}}),H.value=[],j.value=0}finally{L.value=!1}},ve=async()=>{F.value.open=!0,await ne()},fe=()=>{F.value.open=!1,I.value={name:""},U.value=[]},ge=n=>{u.value={open:!0,_id:n._id,companyId:n.companyId,name:n.name}},se=()=>{u.value={open:!1,id:"",companyId:"",name:""},q.value=[]},ye=async()=>{var n,e;if(!I.value.name){U.value=["請輸入公司名稱"];return}f.value=!0;try{const{data:a}=await y.post("/company",{name:I.value.name});a.success&&(v.value.push(a.result),I.value={name:""},U.value=[],r({text:"新增公司成功",snackbarProps:{color:"teal-lighten-1"}}))}catch(a){U.value=[((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"新增失敗"]}finally{f.value=!1}},be=async()=>{var n,e;if(!u.value.name){q.value=["請輸入公司名稱"];return}f.value=!0;try{const{data:a}=await y.patch(`/company/${u.value._id}`,{name:u.value.name,companyId:u.value.companyId});if(a.success){const c=v.value.findIndex(C=>C._id===u.value._id);c!==-1&&(v.value[c]=a.result),u.value={open:!0,_id:"",companyId:"",name:""},q.value=[],se(),r({text:"修改公司成功",snackbarProps:{color:"teal-lighten-1"}})}}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"修改失敗",snackbarProps:{color:"red-lighten-1"}})}finally{f.value=!1}},Ve=n=>{b.value={open:!0,_id:n._id,name:n.name}},ke=async()=>{var n,e;try{await y.delete(`/company/${b.value._id}`),v.value=v.value.filter(a=>a._id!==b.value._id),b.value.open=!1,r({text:"刪除公司成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},Ce=()=>{p.value.open=!0,s.value={c_id:"",name:"",departmentId:"",hasChanges:!0}},K=()=>{p.value={open:!1,id:null},s.value={c_id:"",name:"",departmentId:"",originalData:null,hasChanges:!1},S.value=[],$.value=[]},xe=n=>{var a;console.log("編輯部門資料:",n),p.value={open:!0,id:n._id};const e=((a=n.c_id)==null?void 0:a._id)||n.c_id;s.value={c_id:e,name:n.name,departmentId:n.departmentId,originalData:{c_id:e,name:n.name,departmentId:n.departmentId},hasChanges:!1},console.log("設置後的表單值:",s.value)},_e=async()=>{var n,e,a,c,C,z;if(S.value=[],$.value=[],!s.value.c_id){$.value=["請選擇公司"];return}if(!s.value.name){S.value=["請輸入部門名稱"];return}f.value=!0;try{if(p.value.id){const{data:i}=await y.patch(`/department/${p.value.id}`,{c_id:s.value.c_id,name:s.value.name,departmentId:s.value.departmentId});i.success&&(await g(),K(),r({text:"修改部門成功",snackbarProps:{color:"teal-lighten-1"}}))}else{const{data:i}=await y.post("/department",{c_id:s.value.c_id,name:s.value.name});i.success&&(await g(),K(),r({text:"新增部門成功",snackbarProps:{color:"teal-lighten-1"}}))}}catch(i){const R=((e=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:e.message)||"操作失敗";((c=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:c.field)==="name"?S.value=[R]:((z=(C=i==null?void 0:i.response)==null?void 0:C.data)==null?void 0:z.field)==="c_id"?$.value=[R]:r({text:R,snackbarProps:{color:"red-lighten-1"}})}finally{f.value=!1}},Ie=n=>{k.value={open:!0,id:n._id,name:n.name}},De=async()=>{var n,e;try{await y.delete(`/department/${k.value.id}`),await g(),k.value.open=!1,r({text:"刪除部門成功",snackbarProps:{color:"teal-lighten-1"}})}catch(a){r({text:((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.message)||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},we=de(()=>s.value.originalData?s.value.c_id!==s.value.originalData.c_id||s.value.name!==s.value.originalData.name||s.value.departmentId!==s.value.originalData.departmentId:!0),he=n=>{M.value=n.page,T.value=n.itemsPerPage,B.value=n.sortBy,g()},oe=Ne.debounce(()=>{g(!0)},300);return W(P,()=>{g(!0)}),W(h,()=>{oe()}),W([T,B,P],()=>{g(!0)}),$e(async()=>{await ne(),await g()}),Ee(()=>{oe.cancel()}),(n,e)=>(D(),A(Le,{"max-width":"1400"},{default:t(()=>[l(ae,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-10 mt-2 mt-sm-6 mx-0 mx-sm-4 mx-md-10 mb-4 bg-white"},{default:t(()=>[l(_,{cols:"12",class:"ps-3 pb-6 d-flex align-center"},{default:t(()=>[e[16]||(e[16]=x("h3",null,"公司部門管理",-1)),ue(N)?Te((D(),A(E,{key:0,icon:"mdi-information",size:"small",color:"blue-grey-darken-2",class:"ms-4"},null,512)),[[je,"人數為「在職」人數"]]):Z("",!0)]),_:1}),l(_,{cols:"12"},{default:t(()=>[l(ae,null,{default:t(()=>[l(_,null,{default:t(()=>[l(ae,null,{default:t(()=>[l(_,null,{default:t(()=>[l(m,{"prepend-icon":"mdi-domain",variant:"outlined",color:"blue-grey-darken-2",class:"me-2",onClick:ve},{default:t(()=>e[17]||(e[17]=[d(" 公司管理 ")])),_:1}),l(m,{"prepend-icon":"mdi-account-multiple-plus",variant:"outlined",color:"blue-grey-darken-2",onClick:Ce},{default:t(()=>e[18]||(e[18]=[d(" 新增部門 ")])),_:1})]),_:1}),l(_,{cols:"6",sm:"4",md:"3",lg:"2"},{default:t(()=>[l(me,{modelValue:P.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>P.value=a),e[1]||(e[1]=a=>g(!0))],items:[{name:"全部",_id:""},...v.value],label:"選擇公司","item-title":"name","item-value":"_id",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue","items"])]),_:1}),l(_,{cols:"6",sm:"4",md:"3",class:"d-flex justify-end align-center"},{default:t(()=>[l(w,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=a=>h.value=a),label:"搜尋","append-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(_,{cols:"12"},{default:t(()=>[l(Me,{"items-per-page":T.value,"onUpdate:itemsPerPage":e[3]||(e[3]=a=>T.value=a),"sort-by":B.value,"onUpdate:sortBy":e[4]||(e[4]=a=>B.value=a),headers:ce.value,"header-props":pe,items:H.value,"items-length":j.value,loading:L.value,page:M.value,density:"compact","items-per-page-options":[10,20,50],search:h.value,class:"rounded-ts-lg rounded-te-lg py-3",hover:"","onUpdate:options":he},{item:t(({item:a,index:c})=>{var C;return[x("tr",{class:Be({"odd-row":c%2===0,"even-row":c%2!==0})},[x("td",null,V(a.departmentId||"尚未設定"),1),ue(N)?(D(),ie("td",He,V(((C=a.c_id)==null?void 0:C.name)||"未設定"),1)):Z("",!0),x("td",null,V(a.name),1),x("td",null,V(a.employeeCount)+" 人",1),x("td",Ke,[l(m,{icon:"",color:"light-blue-darken-4",variant:"plain",class:"me-2",onClick:z=>xe(a)},{default:t(()=>[l(E,null,{default:t(()=>e[19]||(e[19]=[d("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),l(m,{icon:"",color:"red-lighten-1",variant:"plain",onClick:z=>Ie(a)},{default:t(()=>[l(E,null,{default:t(()=>e[20]||(e[20]=[d("mdi-delete")])),_:1})]),_:2},1032,["onClick"])])],2)]}),_:1},8,["items-per-page","sort-by","headers","items","items-length","loading","page","search"])]),_:1})]),_:1})]),_:1})]),_:1}),l(ee,{modelValue:F.value.open,"onUpdate:modelValue":e[6]||(e[6]=a=>F.value.open=a),persistent:"",width:"444"},{default:t(()=>[l(G,{class:"rounded-lg pa-4"},{default:t(()=>[l(J,{class:"text-h6 ps-6 py-3"},{default:t(()=>e[21]||(e[21]=[d(" 公司管理 ")])),_:1}),l(O,{class:"px-4"},{default:t(()=>[x("div",Re,[(D(!0),ie(qe,null,Fe(v.value,a=>(D(),A(Ae,{key:a.id,class:"mx-2 mb-2 pa-4 pe-1",color:"blue-grey-darken-1",label:""},{default:t(()=>[d(V(a.companyId)+" "+V(a.name)+" ",1),l(m,{icon:"",size:"x-small",variant:"text",class:"ms-2",ripple:!1,color:"light-blue-darken-4",onClick:c=>ge(a)},{default:t(()=>[l(E,null,{default:t(()=>e[22]||(e[22]=[d("mdi-pencil")])),_:1})]),_:2},1032,["onClick"]),l(m,{icon:"",size:"x-small",variant:"text",ripple:!1,color:"red-lighten-1",onClick:c=>Ve(a)},{default:t(()=>[l(E,null,{default:t(()=>e[23]||(e[23]=[d("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024))),128))]),l(le,{onSubmit:Q(ye,["prevent"])},{default:t(()=>[l(w,{modelValue:I.value.name,"onUpdate:modelValue":e[5]||(e[5]=a=>I.value.name=a),"error-messages":U.value,label:"公司名稱",required:"",variant:"outlined",density:"compact",class:"px-2"},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-2"},{default:t(()=>[l(Y),l(m,{color:"red-lighten-1",variant:"outlined",onClick:fe},{default:t(()=>e[24]||(e[24]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,class:"ms-2"},{default:t(()=>e[25]||(e[25]=[d(" 新增 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:u.value.open,"onUpdate:modelValue":e[9]||(e[9]=a=>u.value.open=a),persistent:"",width:"400"},{default:t(()=>[l(G,{class:"rounded-lg pa-4"},{default:t(()=>[l(J,{class:"text-h6 ps-4 py-3"},{default:t(()=>e[26]||(e[26]=[d(" 編輯公司 ")])),_:1}),l(O,null,{default:t(()=>[l(le,{onSubmit:Q(be,["prevent"])},{default:t(()=>[l(w,{modelValue:u.value.companyId,"onUpdate:modelValue":e[7]||(e[7]=a=>u.value.companyId=a),label:"公司編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"]),l(w,{modelValue:u.value.name,"onUpdate:modelValue":e[8]||(e[8]=a=>u.value.name=a),"error-messages":q.value,label:"公司名稱",required:"",variant:"outlined",density:"compact"},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-4"},{default:t(()=>[l(Y),l(m,{color:"red-lighten-1",variant:"outlined",onClick:se},{default:t(()=>e[27]||(e[27]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,class:"ms-2"},{default:t(()=>e[28]||(e[28]=[d(" 修改 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:p.value.open,"onUpdate:modelValue":e[13]||(e[13]=a=>p.value.open=a),persistent:"",width:"400"},{default:t(()=>[l(G,{class:"rounded-lg pa-4"},{default:t(()=>[l(J,{class:"text-h6 ps-4 py-3"},{default:t(()=>[d(V(p.value.id?"編輯部門":"新增部門"),1)]),_:1}),l(O,null,{default:t(()=>[l(le,{onSubmit:Q(_e,["prevent"])},{default:t(()=>[p.value.id?(D(),A(w,{key:0,modelValue:s.value.departmentId,"onUpdate:modelValue":e[10]||(e[10]=a=>s.value.departmentId=a),label:"部門編號",variant:"outlined",density:"compact",class:"mb-4"},null,8,["modelValue"])):Z("",!0),l(me,{modelValue:s.value.c_id,"onUpdate:modelValue":e[11]||(e[11]=a=>s.value.c_id=a),items:v.value,label:"選擇公司","item-title":"name","item-value":"_id",required:"",variant:"outlined",density:"compact",class:"mb-4","error-messages":$.value},null,8,["modelValue","items","error-messages"]),l(w,{modelValue:s.value.name,"onUpdate:modelValue":e[12]||(e[12]=a=>s.value.name=a),label:"部門名稱",required:"",variant:"outlined",density:"compact","error-messages":S.value},null,8,["modelValue","error-messages"]),l(X,{class:"pa-0 mt-4"},{default:t(()=>[l(Y),l(m,{color:"red-lighten-1",variant:"outlined",onClick:K},{default:t(()=>e[29]||(e[29]=[d(" 取消 ")])),_:1}),l(m,{color:"teal-darken-1",variant:"outlined",type:"submit",loading:f.value,disabled:p.value.id?!we.value:!1,class:"ms-2"},{default:t(()=>[d(V(p.value.id?"修改":"新增"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(re,{modelValue:b.value.open,"onUpdate:modelValue":e[14]||(e[14]=a=>b.value.open=a),title:"確認刪除公司",message:`確定要刪除公司「${b.value.name}」嗎？此操作無法復原。`,"expected-name":b.value.name,"input-label":"公司名稱",onConfirm:ke},null,8,["modelValue","message","expected-name"]),l(re,{modelValue:k.value.open,"onUpdate:modelValue":e[15]||(e[15]=a=>k.value.open=a),title:"確認刪除部門",message:`確定要刪除部門「${k.value.name}」嗎？此操作無法復原。`,"expected-name":k.value.name,"input-label":"部門名稱",onConfirm:De},null,8,["modelValue","message","expected-name"])]),_:1}))}},da=Pe(We,[["__scopeId","data-v-f5b8d048"]]);export{da as default};
