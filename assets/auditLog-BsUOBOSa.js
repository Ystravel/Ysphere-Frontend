import{a0 as Ae,o as W,a2 as Le,P as Ne,x as p,z as ie,A as Oe,ao as h,c as s,a8 as n,as as Pe,U as X,at as je,a5 as qe,a6 as D,ai as ce,ak as ze,ad as k,am as pe,ac as V,au as me,ab as H,H as ge,an as I,K as Z,af as u,ae as E,ap as fe,aj as Fe,av as He,aa as Ee}from"./index-CrP1mq-F.js";import{l as ve}from"./lodash-DHyxJ22h.js";import{V as Be}from"./VContainer-RhMuJ77C.js";import{V as C,a as m}from"./VRow-k1vMvfA4.js";import{V as Ie}from"./VAutocomplete-k3FCf5eq.js";import{V as ye}from"./VTooltip-COY0GB7O.js";import{V as be,a as Ke}from"./VDataTableServer-Bc-PJ1cb.js";import{V as P}from"./VDivider-BXkJRSsW.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./VList-DWCzn2Q2.js";import"./VCheckboxBtn-BdjmP_zZ.js";const ee={1:"永信台北",2:"永信桃園",3:"永信台中",4:"永信高雄",5:"好漾台北",6:"好漾台中",7:"銳皇國際",8:"集睿創映"},Re={key:0},Ye={key:1},Je={key:2},Ge={key:3,class:"py-3"},Qe={class:"text-center"},We={class:"d-flex flex-column gap-4"},Xe={class:"list-content"},Ze={class:"list-content"},et={class:"list-content"},tt={class:"list-content"},at={class:"list-content"},lt={key:0,class:"list-content"},st={class:"change-list"},rt={key:1},nt={__name:"auditLog",setup(ot){const he=W(()=>S.value?"default":"small"),B=Le(),{apiAuth:T}=je(),{smAndUp:S,mdAndUp:te,lgAndUp:ae}=Ne(),x=p([]),g=p([]),K=p(!1),R=p(!1),j=p(""),M=p(""),q=p(!1),Y=p([]),U=p(1),A=p(10),J=p(0),L=p([{key:"createdAt",order:"desc"}]),De={class:"header-bg"},r=p({operatorId:null,targetId:null,action:"",targetModel:"",startDate:null,endDate:null}),z=p(!1),$=p(null),we=e=>{$.value=e,z.value=!0},$e=[{title:"創建",value:"創建"},{title:"修改",value:"修改"},{title:"刪除",value:"刪除"}],ke=[{title:"員工資料",value:"users"},{title:"部門資料",value:"departments"},{title:"設備資料",value:"assets"},{title:"招聘資料",value:"tempUsers"}],G=e=>({users:"員工資料",departments:"部門資料",assets:"資產資料",tempUsers:"招聘資料"})[e]||e,le=e=>{if(!e)return"";if(typeof e=="object"){if(e.name&&e.departmentId)return`${e.name} (${e.departmentId})`;if(e.name&&e.userId)return`${e.name} (${e.userId})`;if(e.name&&N.value==="tempUsers")return e.name}return e},Ve={name:"姓名",englishName:"英文名",email:"電子郵件",cellphone:"手機號碼",extNumber:"分機號碼",printNumber:"列印編號",department:"部門",companyId:"公司",company:"公司",companyName:"公司名稱",jobTitle:"職稱",role:"權限",employmentStatus:"任職狀態",gender:"性別",guideLicense:"領隊證",salary:"薪資",birthDate:"生日",hireDate:"入職日期",resignationDate:"離職日期",emergencyName:"緊急聯絡人",emergencyCellphone:"緊急聯絡電話",emergencyRelationship:"緊急聯絡人關係",permanentAddress:"戶籍地址",contactAddress:"聯絡地址",IDNumber:"身分證號碼",userId:"員工編號",departmentId:"部門編號",note:"備註",description:"描述",cowellAccount:"科威帳號",cowellPassword:"科威密碼",personalEmail:"個人Email",lastModifiedBy:"最後修改人",status:"狀態",isTransferred:"是否轉正",associatedUserId:"轉正後OBJ",effectiveDate:"生效日期",seatDescription:"座位描述"},F=[{title:"操作時間",align:"start",sortable:!0,key:"createdAt"},{title:"操作人員",align:"start",sortable:!0,key:"operatorId"},{title:"資料類型",align:"start",sortable:!0,key:"targetModel"},{title:"動作",align:"start",sortable:!0,key:"actionType"},{title:"操作對象",align:"start",sortable:!0,key:"targetId"},{title:"異動內容",align:"start",sortable:!1,key:"changes"},{title:"查看",align:"center",sortable:!1,key:"actions"}],xe=W(()=>S.value?te.value?ae.value?F:F.filter(e=>e.key!=="changes"):F.filter(e=>["createdAt","operatorId","targetModel","actionType","actions"].includes(e.key)):F.filter(e=>["createdAt","targetModel","actions"].includes(e.key))),_e=ve.debounce(async e=>{K.value=!0;try{const{data:t}=await T.get("/user/suggestions",{params:{search:e}});if(t.success)x.value=t.result;else if(e){const l={name:e,userId:e};x.value=[l],r.value.operatorId=l}else x.value=[]}catch(t){console.error("搜索操作人員失敗:",t),x.value=[]}finally{K.value=!1}},300),Ce=ve.debounce(async e=>{R.value=!0;try{let t;switch(N.value){case"users":if(t=await T.get("/user/suggestions",{params:{search:e}}),t.data.success)g.value=t.data.result.map(l=>({_id:l._id,name:l.name,userId:l.userId}));else if(e){const l={name:e,userId:e};g.value=[l],r.value.targetId=l}else g.value=[];break;case"departments":if(t=await T.get("/department/all",{params:{search:e,searchFields:["name","departmentId"]}}),t.data.success)g.value=t.data.result.data.map(l=>({_id:l._id,name:l.name,departmentId:l.departmentId}));else if(e){const l={name:e,departmentId:e};g.value=[l],r.value.targetId=l}else g.value=[];break;case"tempUsers":if(t=await T.get("/tempuser/all",{params:{quickSearch:e,itemsPerPage:10}}),t.data.success)g.value=t.data.result.data.map(l=>({_id:l._id,name:l.name}));else if(e){const l={name:e};g.value=[l],r.value.targetId=l}else g.value=[];break}}catch(t){console.error("搜尋被操作對象失敗:",t),g.value=[]}finally{R.value=!1}},300),se=()=>{var e;j.value="",x.value=[],((e=r.value.operatorId)==null?void 0:e.name)!==j.value&&(r.value.operatorId=null)},re=()=>{var e;M.value="",g.value=[],((e=r.value.targetId)==null?void 0:e.name)!==M.value&&(r.value.targetId=null)},ne=e=>{if(!e)return"-";const t=new Date(e),l=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${l(t.getMonth()+1)}-${l(t.getDate())} ${l(t.getHours())}:${l(t.getMinutes())}`},Se=e=>{if(!e)return"(無)";const t=new Date(e),l=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${l(t.getMonth()+1)}-${l(t.getDate())}`},oe=e=>{var t,l,a;return e?(t=e.operator)!=null&&t.name&&((l=e.operator)!=null&&l.userId)?`${e.operator.name} (${e.operator.userId})`:(a=e.operatorInfo)!=null&&a.name?`${e.operatorInfo.name}${e.operatorInfo.userId?` (${e.operatorInfo.userId})`:""}`:"系統":"-"},de=e=>{var t,l,a,o,f,d,i,v,c,w;if(!e)return"-";if(e.targetData)switch(e.targetModel){case"users":{const b=e.targetData.name||"-",y=e.targetData.userId?` (${e.targetData.userId})`:"";return`${b}${y}`}case"departments":{const b=e.targetData.name||"-",y=e.targetData.departmentId?` (${e.targetData.departmentId})`:"",_=ee[e.targetData.companyId]||"";return`${b}${y}${_?` - ${_}`:""}`}default:return`${e.targetData.name||"-"}`}if(e.targetInfo)switch(e.targetModel){case"users":{const b=e.targetInfo.name||"-",y=e.targetInfo.userId?` (${e.targetInfo.userId})`:"";return`${b}${y}`}case"departments":{const b=e.targetInfo.name||"-",y=e.targetInfo.departmentId?` (${e.targetInfo.departmentId})`:"",_=ee[e.targetInfo.companyId]||"";return`${b}${y}${_?` - ${_}`:""}`}default:return`${e.targetInfo.name||"-"}`}if(e.changes)switch(e.targetModel){case"users":{const b=e.action==="刪除"?((t=e.changes.name)==null?void 0:t.from)||"-":((l=e.changes.name)==null?void 0:l.to)||"-",y=e.action==="刪除"?((a=e.changes.userId)==null?void 0:a.from)||"":((o=e.changes.userId)==null?void 0:o.to)||"";return`${b}${y?` (${y})`:""}`}case"departments":{const b=e.action==="刪除"?((f=e.changes.name)==null?void 0:f.from)||"-":((d=e.changes.name)==null?void 0:d.to)||"-",y=e.action==="刪除"?((i=e.changes.departmentId)==null?void 0:i.from)||"":((v=e.changes.departmentId)==null?void 0:v.to)||"",_=e.action==="刪除"?((c=e.changes.companyId)==null?void 0:c.from)||"":((w=e.changes.companyId)==null?void 0:w.to)||"",ue=ee[_]||"";return`${b}${y?` (${y})`:""}${ue?` - ${ue}`:""}`}default:return"-"}return"-"},Te=(e,t="")=>{if(e==="name"){if(t==="users")return"姓名";if(t==="departments")return"部門名稱"}return Ve[e]||e},Q=e=>{if(!(e!=null&&e.changes))return[];const t=[],l=new Set;return Object.entries(e.changes).forEach(([a,o])=>{if(!o||typeof o!="object"||!("from"in o)&&!("to"in o)||l.has(a))return;const f=(c,w)=>{if(c==null)return"(無)";switch(w){case"IDNumber":case"englishName":return c.toString();case"department":return c.toString();default:return typeof c=="string"&&c.includes("T")?Se(c):c}},d=f(o.from,a),i=f(o.to,a),v=Te(a,e.targetModel);if(e.action==="創建"){i!=="(無)"&&(t.push(`${v}: ${i}`),l.add(a));return}if(d!==i&&v){const c=d==="(無)"?d:d.toString(),w=i==="(無)"?i:i.toString();t.push(`${v}: ${c} → ${w}`),l.add(a)}}),e.action==="創建"&&t.length===0&&t.push(`新增${G(e.targetModel)}`),t},Me=()=>{r.value={operatorId:null,targetId:null,action:"",targetModel:"",startDate:null,endDate:null},se(),re(),O()},N=W(()=>r.value.targetModel),O=async()=>{var e,t,l,a,o,f;if(r.value.startDate&&r.value.endDate){const d=new Date(r.value.startDate),i=new Date(r.value.endDate);if(d>i){B({text:"結束日期不能早於開始日期",snackbarProps:{color:"warning"}});return}}q.value=!0;try{const d={page:U.value,itemsPerPage:A.value,sortBy:((e=L.value[0])==null?void 0:e.key)||"createdAt",sortOrder:((t=L.value[0])==null?void 0:t.order)||"desc"};if(r.value.startDate){const v=new Date(r.value.startDate);v.setHours(0,0,0,0),d.startDate=v.toISOString()}if(r.value.endDate){const v=new Date(r.value.endDate);v.setHours(23,59,59,999),d.endDate=v.toISOString()}(l=r.value.operatorId)!=null&&l._id&&(d.operatorId=r.value.operatorId._id),(a=r.value.targetId)!=null&&a._id&&(d.targetId=r.value.targetId._id),r.value.action&&(d.action=r.value.action),r.value.targetModel&&(d.targetModel=r.value.targetModel);const i=await T.get("/auditlog/all",{params:d});if(i.data.success){const{data:v,totalItems:c}=i.data.result;Y.value=v,J.value=c;const w=Math.ceil(c/A.value);w>0&&U.value>w&&(U.value=w,await O())}else throw new Error(i.data.message)}catch(d){console.error("搜尋失敗:",d),B({text:((f=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:f.message)||"搜尋時發生錯誤",snackbarProps:{color:"error"}}),Y.value=[],J.value=0}finally{q.value=!1}},Ue=async({page:e,itemsPerPage:t,sortBy:l})=>{U.value=e,A.value=t,(l==null?void 0:l.length)>0&&(L.value=l),await O()};return ie([()=>r.value.startDate,()=>r.value.endDate],([e,t])=>{if(e&&t){const l=new Date(e),a=new Date(t);l>a&&(B({text:"結束日期不能早於開始日期",snackbarProps:{color:"warning"}}),r.value.endDate=null)}}),ie(()=>r.value.targetModel,e=>{r.value.targetId=null,M.value="",g.value=[]}),Oe(async()=>{await O()}),(e,t)=>{const l=qe("v-date-input");return D(),h(X,null,[s(Be,{"max-width":"2500"},{default:n(()=>[s(C,{class:"pt-md-5"},{default:n(()=>[s(m,{cols:"12",lg:"4",xl:"3"},{default:n(()=>[s(C,null,{default:n(()=>[s(m,{cols:"12",class:"mt-1 px-lg-10"},{default:n(()=>[s(ce,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-4 px-sm-4 px-xl-8"},{default:n(()=>[s(ze,{class:"font-weight-bold d-flex align-center"},{default:n(()=>t[14]||(t[14]=[k(" 搜尋條件 ")])),_:1}),s(pe,{class:"pa-2"},{default:n(()=>[s(C,null,{default:n(()=>[s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(Ie,{modelValue:r.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=a=>r.value.operatorId=a),"search-input":j.value,"onUpdate:searchInput":t[1]||(t[1]=a=>j.value=a),items:x.value,loading:K.value,label:"操作人員","return-object":"","item-props":a=>({title:`${a.name} (${a.userId})`,value:a}),variant:"outlined",density:"compact","hide-details":"",clearable:"",creatable:"","create-filter":`(item, queryText, itemText) =>
    item.name.toLowerCase().indexOf(queryText.toLowerCase()) > -1 ||
    item.userId.toLowerCase().indexOf(queryText.toLowerCase()) > -1`,"onUpdate:search":V(_e),"onClick:clear":se,onCreate:t[2]||(t[2]=a=>{const o={name:a,userId:a};x.value.value.push(o),r.value.value.operatorId=o})},me({selection:n(({item:a})=>{var o;return[k(I((o=a==null?void 0:a.props)==null?void 0:o.title),1)]}),_:2},[V(S)?{name:"append-inner",fn:n(()=>[s(ye,{location:"top","close-delay":"200"},{activator:n(({props:a})=>[s(H,ge(a,{icon:"mdi-information",size:"18"}),null,16)]),default:n(()=>[t[15]||(t[15]=k(" 輸入員編、姓名查詢 "))]),_:1})]),key:"0"}:void 0]),1032,["modelValue","search-input","items","loading","item-props","onUpdate:search"])]),_:1}),s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(be,{modelValue:r.value.targetModel,"onUpdate:modelValue":t[3]||(t[3]=a=>r.value.targetModel=a),items:ke,label:"資料類型","item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(Ie,{modelValue:r.value.targetId,"onUpdate:modelValue":t[4]||(t[4]=a=>r.value.targetId=a),"search-input":M.value,"onUpdate:searchInput":t[5]||(t[5]=a=>M.value=a),items:g.value,loading:R.value,label:N.value?"操作對象":"操作對象( 請先選擇資料類型 )",disabled:!N.value,"return-object":"","item-props":a=>({title:le(a),value:a}),variant:"outlined",density:"compact","hide-details":"",clearable:"",creatable:"","create-filter":`(item, queryText, itemText) =>
    item.name.toLowerCase().indexOf(queryText.toLowerCase()) > -1 ||
    (item.userId && item.userId.toLowerCase().indexOf(queryText.toLowerCase()) > -1) ||
    (item.departmentId && item.departmentId.toLowerCase().indexOf(queryText.toLowerCase()) > -1)`,"onUpdate:search":V(Ce),"onClick:clear":re,onCreate:t[6]||(t[6]=a=>{let o;switch(N.value.value){case"users":o={name:a,userId:a};break;case"departments":o={name:a,departmentId:a};break}g.value.value.push(o),r.value.value.targetId=o})},me({selection:n(({item:a})=>[k(I(le(a.props.value)),1)]),_:2},[V(S)?{name:"append-inner",fn:n(()=>[s(ye,{location:"top","close-delay":"200"},{activator:n(({props:a})=>[s(H,ge(a,{icon:"mdi-information",size:"18"}),null,16)]),default:n(()=>[t[16]||(t[16]=k(" 輸入員編、姓名、部門編號、部門名稱、設備編號、設備名稱查詢 "))]),_:1})]),key:"0"}:void 0]),1032,["modelValue","search-input","items","loading","label","disabled","item-props","onUpdate:search"])]),_:1}),s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(be,{modelValue:r.value.action,"onUpdate:modelValue":t[7]||(t[7]=a=>r.value.action=a),items:$e,label:"操作類型","item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":"",clearable:""},null,8,["modelValue"])]),_:1}),s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(l,{modelValue:r.value.startDate,"onUpdate:modelValue":t[8]||(t[8]=a=>r.value.startDate=a),label:"開始日期","prepend-icon":"",variant:"outlined",density:"compact","hide-details":"",clearable:"","cancel-text":"取消","ok-text":"確認"},null,8,["modelValue"])]),_:1}),s(m,{cols:"12",sm:"6",lg:"12"},{default:n(()=>[s(l,{modelValue:r.value.endDate,"onUpdate:modelValue":t[9]||(t[9]=a=>r.value.endDate=a),label:"結束日期","prepend-icon":"",variant:"outlined",density:"compact","hide-details":"",clearable:"","cancel-text":"取消","ok-text":"確認",min:r.value.startDate},null,8,["modelValue","min"])]),_:1})]),_:1}),s(C,null,{default:n(()=>[s(m,{cols:"12",class:"d-flex justify-end gap-2"},{default:n(()=>[s(C,{class:"d-flex justify-space-between"},{default:n(()=>[s(m,{cols:"3"},{default:n(()=>[s(Z,{color:"grey",width:"40",block:"",onClick:Me},{default:n(()=>[s(H,null,{default:n(()=>t[17]||(t[17]=[k("mdi-refresh")])),_:1})]),_:1})]),_:1}),s(m,{cols:"9",class:"ps-0"},{default:n(()=>[s(Z,{color:"blue-grey-darken-1","prepend-icon":"mdi-magnify",loading:q.value,block:"",onClick:O},{default:n(()=>t[18]||(t[18]=[k(" 搜尋 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(m,{cols:"12",lg:"8",xl:"9",class:"px-6 ps-lg-4 pe-lg-12 mb-6"},{default:n(()=>[s(C,{class:"elevation-4 rounded-xl py-4 py-sm-8 px-1 px-sm-4 px-md-10 mt-1 bg-white"},{default:n(()=>[s(m,{cols:"12",class:"ps-4 pb-sm-6"},{default:n(()=>t[19]||(t[19]=[u("h3",null,"異動紀錄",-1)])),_:1}),s(m,{cols:"12"},{default:n(()=>[s(Ke,{"items-per-page":A.value,"onUpdate:itemsPerPage":t[10]||(t[10]=a=>A.value=a),"sort-by":L.value,"onUpdate:sortBy":t[11]||(t[11]=a=>L.value=a),items:Y.value,headers:xe.value,loading:q.value,"items-length":J.value,"items-per-page-options":[10,20,50,100],page:U.value,"header-props":De,hover:"",density:"compact",class:"rounded-ts-lg rounded-te-lg","onUpdate:options":Ue},{item:n(({item:a,index:o})=>[u("tr",{class:Fe({"odd-row":o%2===0,"even-row":o%2!==0})},[u("td",null,I(ne(a.createdAt)),1),V(S)?(D(),h("td",Re,I(oe(a)),1)):E("",!0),u("td",null,I(G(a.targetModel)),1),V(S)?(D(),h("td",Ye,I(a.action),1)):E("",!0),V(te)?(D(),h("td",Je,I(de(a)),1)):E("",!0),V(ae)?(D(),h("td",Ge,[(D(!0),h(X,null,fe(Q(a),(f,d)=>(D(),h("div",{key:d},I(f),1))),128))])):E("",!0),u("td",Qe,[s(H,{icon:"mdi-book-open-variant-outline",color:"blue-grey-darken-3",size:"small",class:"my-4",onClick:f=>we(a)},null,8,["onClick"])])],2)]),_:1},8,["items-per-page","sort-by","items","headers","loading","items-length","page"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(Pe,{modelValue:z.value,"onUpdate:modelValue":t[13]||(t[13]=a=>z.value=a),width:"600"},{default:n(()=>[s(ce,{class:"pa-4"},{default:n(()=>[t[27]||(t[27]=u("div",{class:"ps-6 pt-4 pb-1 pb-sm-3 card-title"}," 異動詳細資料 ",-1)),s(pe,null,{default:n(()=>[s(C,null,{default:n(()=>[s(m,{cols:"12"},{default:n(()=>{var a,o,f;return[u("div",We,[u("div",null,[t[20]||(t[20]=u("div",{class:"text-grey-darken-1 list-title"}," 操作時間 ",-1)),u("div",Xe,I(ne((a=$.value)==null?void 0:a.createdAt)),1)]),s(P,{class:"my-2"}),u("div",null,[t[21]||(t[21]=u("div",{class:"text-grey-darken-1 list-title"}," 操作人員 ",-1)),u("div",Ze,I(oe($.value)),1)]),s(P,{class:"my-2"}),u("div",null,[t[22]||(t[22]=u("div",{class:"text-grey-darken-1 list-title"}," 操作對象 ",-1)),u("div",et,I(de($.value)),1)]),s(P,{class:"my-2"}),u("div",null,[t[23]||(t[23]=u("div",{class:"text-grey-darken-1 list-title"}," 操作類型 ",-1)),u("div",tt,I((o=$.value)==null?void 0:o.action),1)]),s(P,{class:"my-2"}),u("div",null,[t[24]||(t[24]=u("div",{class:"text-grey-darken-1 list-title"}," 資料類型 ",-1)),u("div",at,I(G((f=$.value)==null?void 0:f.targetModel)),1)]),s(P,{class:"my-2"}),u("div",null,[t[25]||(t[25]=u("div",{class:"text-grey-darken-1 list-title"}," 異動內容 ",-1)),Q($.value).length>0?(D(),h("div",lt,[u("ul",st,[(D(!0),h(X,null,fe(Q($.value),(d,i)=>(D(),h("li",{key:i,class:"py-2"},I(d),1))),128))])])):(D(),h("div",rt," 無異動內容 "))])])]}),_:1})]),_:1})]),_:1}),s(He,null,{default:n(()=>[s(Ee),s(Z,{color:"grey-darken-1",variant:"outlined",size:he.value,onClick:t[12]||(t[12]=a=>z.value=!1)},{default:n(()=>t[26]||(t[26]=[k(" 關閉 ")])),_:1},8,["size"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}},bt=Ae(nt,[["__scopeId","data-v-ca1800b9"]]);export{bt as default};
